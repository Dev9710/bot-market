<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Details - Scanner V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="trading_strategy.js"></script>
    <style>
        body {
            background: #0a0a0a;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .card {
            background: linear-gradient(135deg, #1a1a1a 0%, #1f1f1f 100%);
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 24px;
        }

        .card-success {
            border-color: #22c55e;
            background: linear-gradient(135deg, #1a1a1a 0%, #1a2e1f 100%);
        }

        .card-warning {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #1a1a1a 0%, #2e251a 100%);
        }

        .card-danger {
            border-color: #ef4444;
            background: linear-gradient(135deg, #1a1a1a 0%, #2e1a1a 100%);
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid #2a2a2a;
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success { background: #22c55e20; color: #22c55e; border: 1px solid #22c55e40; }
        .badge-warning { background: #f59e0b20; color: #f59e0b; border: 1px solid #f59e0b40; }
        .badge-danger { background: #ef444420; color: #ef4444; border: 1px solid #ef444440; }
        .badge-info { background: #3b82f620; color: #3b82f6; border: 1px solid #3b82f640; }
        .badge-purple { background: #8b5cf620; color: #8b5cf6; border: 1px solid #8b5cf640; }

        .decision-card {
            border: 2px solid;
            padding: 32px;
            border-radius: 20px;
            text-align: center;
        }

        .target-pill {
            background: #0a0a0a;
            padding: 16px;
            border-radius: 12px;
            border-left: 4px solid;
        }

        .target-pill.entry { border-color: #3b82f6; }
        .target-pill.sl { border-color: #ef4444; }
        .target-pill.tp { border-color: #22c55e; }
    </style>
</head>
<body class="text-white min-h-screen p-4 md:p-8">
    <!-- Header -->
    <div class="max-w-7xl mx-auto mb-6">
        <a href="javascript:history.back()" class="text-gray-400 hover:text-white transition text-sm inline-flex items-center gap-2 mb-4">
            ‚Üê Retour
        </a>

        <div class="flex items-start justify-between flex-wrap gap-4">
            <div>
                <h1 class="text-4xl md:text-5xl font-bold mb-2" id="tokenSymbol">-</h1>
                <p class="text-gray-400 text-lg" id="tokenName">-</p>
                <div class="flex gap-2 mt-3">
                    <span class="badge badge-info" id="networkBadge">-</span>
                    <span class="badge" id="ageBadge">-</span>
                </div>
            </div>
            <div class="text-right">
                <div class="text-sm text-gray-400 mb-1">Quality Score</div>
                <div class="text-5xl font-bold mb-2" id="scoreDisplay">-</div>
                <div class="badge badge-purple" id="tierBadge">-</div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="max-w-7xl mx-auto text-center py-20">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500 mb-4"></div>
        <div class="text-gray-400">Chargement des donn√©es...</div>
    </div>

    <!-- Content -->
    <div id="content" class="max-w-7xl mx-auto space-y-6" style="display: none;">

        <!-- ============ SECTION 1: TRADING DECISION (PRIORITY #1) ============ -->
        <div class="decision-card" id="decisionCard">
            <div class="mb-6">
                <h2 class="text-3xl font-bold mb-2" id="decisionAction">-</h2>
                <p class="text-lg text-gray-300" id="decisionConfidence">-</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-left">
                <div>
                    <div class="text-sm text-gray-400 mb-2">Position Recommand√©e</div>
                    <div class="text-2xl font-bold" id="positionSize">-</div>
                </div>
                <div>
                    <div class="text-sm text-gray-400 mb-2">Risque</div>
                    <div class="text-2xl font-bold" id="riskLevel">-</div>
                </div>
                <div>
                    <div class="text-sm text-gray-400 mb-2">Multiplicateur</div>
                    <div class="text-2xl font-bold text-purple-400" id="multiplier">-</div>
                </div>
            </div>

            <!-- Checklist Progress -->
            <div class="mt-6 pt-6 border-t border-gray-700">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm font-semibold" id="strategyName">Strat√©gie</span>
                    <span class="text-lg font-bold" id="checklistProgress">-/-</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-3">
                    <div id="progressBar" class="h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- ============ SECTION 2: TARGETS & ENTRY ============ -->
        <div class="card">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                <span>üéØ</span>
                <span>Prix & Targets Dynamiques</span>
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                <div class="target-pill entry">
                    <div class="text-xs text-gray-400 mb-1">Entry Price</div>
                    <div class="text-xl font-bold text-blue-400" id="entryPrice">-</div>
                </div>

                <div class="target-pill sl">
                    <div class="text-xs text-gray-400 mb-1">Stop Loss</div>
                    <div class="text-xl font-bold text-red-400" id="stopLoss">-</div>
                </div>

                <div class="target-pill tp">
                    <div class="text-xs text-gray-400 mb-1">TP1 ‚Üí Exit 50%</div>
                    <div class="text-xl font-bold text-green-400" id="tp1">-</div>
                </div>

                <div class="target-pill tp">
                    <div class="text-xs text-gray-400 mb-1">TP2 ‚Üí Exit 30%</div>
                    <div class="text-xl font-bold text-green-400" id="tp2">-</div>
                </div>

                <div class="target-pill tp">
                    <div class="text-xs text-gray-400 mb-1">TP3 ‚Üí Exit 20%</div>
                    <div class="text-xl font-bold text-green-400" id="tp3">-</div>
                </div>

                <div class="target-pill" style="border-color: #f59e0b;">
                    <div class="text-xs text-gray-400 mb-1">Trail Stop</div>
                    <div class="text-lg font-bold text-yellow-400" id="trailStop">-</div>
                </div>
            </div>

            <!-- Reasoning (Collapsible) -->
            <details class="mt-4">
                <summary class="cursor-pointer text-sm text-gray-400 hover:text-white transition flex items-center gap-2">
                    <span>‚Üí</span>
                    <span>Voir le raisonnement</span>
                </summary>
                <div id="targetReasoning" class="mt-3 space-y-1 text-sm text-gray-300 pl-4">
                    <!-- Populated by JS -->
                </div>
            </details>
        </div>

        <!-- ============ SECTION 3: STRATEGY VALIDATION ============ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Strategy Checklist -->
            <div class="card" id="checklistCard">
                <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span>‚úì</span>
                    <span id="checklistTitle">Validation Strat√©gie</span>
                </h3>

                <div id="checklistItems" class="space-y-2">
                    <!-- Populated by JS -->
                </div>

                <div id="checklistResult" class="mt-4">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Patterns & Signals -->
            <div class="card">
                <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span>üîç</span>
                    <span>Patterns & Signaux</span>
                </h3>

                <div id="optimalZone" class="mb-4">
                    <!-- Populated by JS -->
                </div>

                <div id="patterns" class="mb-4">
                    <!-- Populated by JS -->
                </div>

                <div id="bullishSignals">
                    <!-- Populated by JS -->
                </div>

                <div id="scoreBreakdown" class="mt-4 pt-4 border-t border-gray-700">
                    <details>
                        <summary class="cursor-pointer text-sm text-gray-400 hover:text-white transition flex items-center gap-2">
                            <span>‚Üí</span>
                            <span>D√©tails du score (Score Auto: <span id="autoScore">-</span>/100)</span>
                        </summary>
                        <div id="breakdownList" class="mt-3 space-y-1">
                            <!-- Populated by JS -->
                        </div>
                    </details>
                </div>
            </div>
        </div>

        <!-- ============ SECTION 4: PRICE CHART ============ -->
        <div class="card">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                <span>üìà</span>
                <span>Graphique Prix (Temps R√©el)</span>
            </h2>
            <div id="chartContainer" class="rounded-lg overflow-hidden" style="height: 500px;">
                <!-- GeckoTerminal iframe will be inserted here -->
            </div>
        </div>

        <!-- ============ SECTION 5: KEY METRICS ============ -->
        <div class="card">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                <span>üìä</span>
                <span>M√©triques Cl√©s</span>
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Liquidit√© & Volume -->
                <div>
                    <h3 class="text-sm font-semibold text-green-400 mb-3">üí∞ Liquidit√© & Volume</h3>
                    <div class="space-y-2">
                        <div class="metric-row">
                            <span class="text-sm text-gray-400">Liquidit√©</span>
                            <span class="font-semibold" id="liquidity">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="text-sm text-gray-400">Volume 24h</span>
                            <span class="font-semibold" id="volume24h">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="text-sm text-gray-400">Vol/Liq Ratio</span>
                            <span class="font-semibold text-purple-400" id="volLiqRatio">-</span>
                        </div>
                    </div>
                </div>

                <!-- Momentum -->
                <div>
                    <h3 class="text-sm font-semibold text-blue-400 mb-3">‚ö° Momentum</h3>
                    <div class="space-y-2">
                        <div class="metric-row">
                            <span class="text-sm text-gray-400">V√©locit√© Pump</span>
                            <span class="font-semibold" id="velocity">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="text-sm text-gray-400">Acc√©l. 1h vs 6h</span>
                            <span class="font-semibold" id="accel1h">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="text-sm text-gray-400">Acc√©l. 6h vs 24h</span>
                            <span class="font-semibold" id="accel6h">-</span>
                        </div>
                    </div>
                </div>

                <!-- Transactions -->
                <div>
                    <h3 class="text-sm font-semibold text-purple-400 mb-3">üîÑ Transactions 24h</h3>
                    <div class="space-y-2">
                        <div class="metric-row">
                            <span class="text-sm text-gray-400">Buys</span>
                            <span class="font-semibold text-green-400" id="buys">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="text-sm text-gray-400">Sells</span>
                            <span class="font-semibold text-red-400" id="sells">-</span>
                        </div>
                        <div class="metric-row">
                            <span class="text-sm text-gray-400">Buy Ratio</span>
                            <span class="font-semibold" id="buyRatio">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============ SECTION 6: ALERT HISTORY (if multiple alerts) ============ -->
        <div id="historySection" class="space-y-6" style="display: none;">
            <!-- Alert Badge -->
            <div class="card card-warning">
                <div class="flex items-center gap-3">
                    <span class="text-3xl">üî•</span>
                    <div>
                        <h3 class="text-lg font-bold text-orange-400">Alertes Multiples D√©tect√©es</h3>
                        <p class="text-sm text-gray-400">Ce token a √©t√© alert√© <span id="alertCount" class="font-bold text-orange-400">-</span> fois</p>
                    </div>
                </div>
            </div>

            <!-- Evolution Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card">
                    <h3 class="text-lg font-bold mb-4 text-green-400">üí∞ √âvolution Liquidit√©</h3>
                    <div style="height: 250px;">
                        <canvas id="liquidityChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3 class="text-lg font-bold mb-4 text-blue-400">üìä √âvolution Score</h3>
                    <div style="height: 250px;">
                        <canvas id="scoreChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Timeline -->
            <div class="card">
                <h3 class="text-lg font-bold mb-4 text-purple-400">üïí Historique des Alertes</h3>
                <div id="timelineList" class="space-y-3">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- ============ SECTION 7: ACTIONS ============ -->
        <div class="card">
            <div class="flex flex-wrap gap-4">
                <button id="addToPortfolioBtn" onclick="addToPortfolio()"
                    class="px-6 py-3 bg-purple-500/20 text-purple-400 rounded-lg hover:bg-purple-500/30 transition border border-purple-500/30 font-semibold">
                    + Ajouter au Portfolio
                </button>
                <a id="geckoLink" href="#" target="_blank"
                    class="px-6 py-3 bg-green-500/20 text-green-400 rounded-lg hover:bg-green-500/30 transition border border-green-500/30 font-semibold">
                    Voir sur GeckoTerminal ‚Üí
                </a>
                <button onclick="history.back()"
                    class="px-6 py-3 bg-gray-500/20 text-gray-400 rounded-lg hover:bg-gray-500/30 transition border border-gray-500/30">
                    ‚Üê Retour
                </button>
            </div>
            <div id="portfolioMessage" class="mt-4 hidden"></div>
        </div>

        <!-- Debug: Raw Data (Collapsible) -->
        <details class="card">
            <summary class="cursor-pointer text-sm text-gray-400 hover:text-white transition">
                ‚Üí Donn√©es brutes (Debug)
            </summary>
            <pre class="mt-4 text-xs text-gray-400 whitespace-pre-wrap font-mono bg-black/50 p-4 rounded" id="rawData">-</pre>
        </details>
    </div>

    <script>
        const API_URL = window.location.origin + '/api';
        const urlParams = new URLSearchParams(window.location.search);
        const alertId = urlParams.get('id');

        let alertHistory = [];
        let currentAlert = null;
        let scoreChart = null;
        let liquidityChart = null;

        async function loadToken() {
            if (!alertId) {
                document.getElementById('loading').innerHTML = '<div class="text-red-400">ID manquant</div>';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/alerts/${alertId}`);
                const data = await response.json();

                if (data.error) throw new Error(data.error);

                currentAlert = data;
                await loadAlertHistory(data.pool_address || data.token_address);
                renderToken(data);

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').innerHTML = `<div class="text-red-400">Erreur: ${error.message}</div>`;
            }
        }

        async function loadAlertHistory(poolAddress) {
            if (!poolAddress) return;

            try {
                const response = await fetch(`${API_URL}/alerts/token/${poolAddress}`);
                const data = await response.json();

                if (data.alerts && data.alerts.length > 1) {
                    alertHistory = data.alerts;
                    document.getElementById('historySection').style.display = 'block';
                    document.getElementById('alertCount').textContent = data.count;
                    renderTimeline(alertHistory);
                    renderCharts(alertHistory);
                }
            } catch (error) {
                console.error('Error loading alert history:', error);
            }
        }

        function renderToken(alert) {
            // Hide loading, show content
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';

            const fullData = alert.full_data || alert || {};
            const network = (alert.network || 'Unknown').toUpperCase();
            const ageHours = alert.age_hours || 0;

            // ===== HEADER =====
            document.getElementById('tokenSymbol').textContent = alert.token_symbol || 'N/A';
            document.getElementById('tokenName').textContent = alert.token_name || 'N/A';
            document.getElementById('networkBadge').textContent = network;
            document.getElementById('ageBadge').innerHTML = getFreshnessDisplay(ageHours);
            document.getElementById('scoreDisplay').textContent = alert.score || 0;
            document.getElementById('scoreDisplay').className = `text-5xl font-bold mb-2 ${getScoreColor(alert.score)}`;
            document.getElementById('tierBadge').textContent = alert.tier || 'N/A';

            // ===== CALCULATE STRATEGY =====
            const previousAlerts = alertHistory.filter(a => a.id !== alert.id);
            const { score: autoScore, breakdown } = calculateAutoScore({
                ...alert,
                ...fullData,
                alert_count: alertHistory.length || 1
            });

            const zoneCheck = checkOptimalZone(alert);
            const checklist = generateChecklist(alert, zoneCheck);
            const targets = calculateDynamicTargets(alert, previousAlerts);

            const checklistRatio = checklist.passed / checklist.total;
            const recommendation = getFinalRecommendation(autoScore, checklistRatio, checklist.passed, checklist.total);

            // ===== TRADING DECISION CARD =====
            const decisionCard = document.getElementById('decisionCard');

            if (checklistRatio >= 1.0 && autoScore >= 85) {
                decisionCard.className = 'decision-card border-green-500 bg-green-900/10';
                decisionCard.querySelector('#decisionAction').className = 'text-3xl font-bold mb-2 text-green-400';
            } else if (checklistRatio >= 0.6) {
                decisionCard.className = 'decision-card border-yellow-500 bg-yellow-900/10';
                decisionCard.querySelector('#decisionAction').className = 'text-3xl font-bold mb-2 text-yellow-400';
            } else {
                decisionCard.className = 'decision-card border-red-500 bg-red-900/10';
                decisionCard.querySelector('#decisionAction').className = 'text-3xl font-bold mb-2 text-red-400';
            }

            document.getElementById('decisionAction').textContent = recommendation.action;
            document.getElementById('decisionConfidence').textContent = recommendation.confidence;
            document.getElementById('positionSize').textContent = recommendation.position;
            document.getElementById('riskLevel').textContent = targets.riskLevel;
            document.getElementById('riskLevel').className = `text-2xl font-bold ${targets.riskLevel === 'LOW' ? 'text-green-400' : targets.riskLevel === 'HIGH' ? 'text-red-400' : 'text-yellow-400'}`;
            document.getElementById('multiplier').textContent = '√ó' + targets.multiplier;

            // Progress bar
            document.getElementById('strategyName').textContent = `Strat√©gie ${network}`;
            document.getElementById('checklistProgress').textContent = `${checklist.passed}/${checklist.total}`;
            const progressPct = (checklist.passed / checklist.total * 100).toFixed(0);
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = progressPct + '%';
            progressBar.className = `h-3 rounded-full transition-all duration-500 ${checklistRatio >= 1.0 ? 'bg-green-400' : checklistRatio >= 0.6 ? 'bg-yellow-400' : 'bg-red-400'}`;

            // ===== TARGETS =====
            const price = fullData.entry_price || alert.price || 0;
            document.getElementById('entryPrice').textContent = formatPrice(targets.entry || price);
            document.getElementById('stopLoss').textContent = `${formatPrice(targets.stopLoss.price)} (${targets.stopLoss.percent}%)`;
            document.getElementById('tp1').textContent = `${formatPrice(targets.tp1.price)} (+${targets.tp1.percent.toFixed(1)}%)`;
            document.getElementById('tp2').textContent = `${formatPrice(targets.tp2.price)} (+${targets.tp2.percent.toFixed(1)}%)`;
            document.getElementById('tp3').textContent = `${formatPrice(targets.tp3.price)} (+${targets.tp3.percent.toFixed(1)}%)`;
            document.getElementById('trailStop').textContent = `${targets.trailStop.percent}% ${targets.trailStop.activation}`;

            document.getElementById('targetReasoning').innerHTML = targets.reasoning.map(r =>
                `<div class="text-sm">‚Ä¢ ${r}</div>`
            ).join('');

            // ===== CHECKLIST =====
            document.getElementById('checklistTitle').textContent = `Validation Strat√©gie ${network}`;
            document.getElementById('checklistItems').innerHTML = checklist.items.map(item => {
                if (item.isBonus) {
                    return `
                        <div class="p-3 rounded-lg ${item.passed ? 'bg-purple-900/30 border-l-4 border-purple-500' : 'bg-gray-900/30 border-l-4 border-gray-600'}">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">${item.passed ? 'üöÄ' : '‚óã'}</span>
                                <div class="flex-1">
                                    <div class="text-sm font-semibold flex items-center gap-2">
                                        ${item.label}
                                        <span class="badge badge-purple">BONUS</span>
                                    </div>
                                    <div class="text-xs ${item.passed ? 'text-purple-400' : 'text-gray-500'} font-semibold mt-1">${item.value}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                return `
                    <div class="p-3 rounded-lg ${item.passed ? 'bg-green-900/20 border-l-4 border-green-500' : 'bg-red-900/20 border-l-4 border-red-500'}">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">${item.passed ? '‚úÖ' : '‚ùå'}</span>
                            <div class="flex-1">
                                <div class="text-sm font-semibold">${item.label}</div>
                                <div class="text-xs ${item.passed ? 'text-green-400' : 'text-red-400'} font-semibold mt-1">${item.value}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            if (checklist.passed === checklist.total) {
                document.getElementById('checklistResult').innerHTML = `
                    <div class="p-3 rounded-lg bg-green-500/10 border border-green-500/30 text-green-400 text-sm font-bold text-center">
                        üéØ Tous les crit√®res valid√©s - GO TRADE!
                    </div>
                `;
            } else if (checklist.passed >= checklist.total * 0.6) {
                document.getElementById('checklistResult').innerHTML = `
                    <div class="p-3 rounded-lg bg-yellow-500/10 border border-yellow-500/30 text-yellow-400 text-sm text-center">
                        ‚ö†Ô∏è Entry possible mais prudent
                    </div>
                `;
            } else {
                document.getElementById('checklistResult').innerHTML = `
                    <div class="p-3 rounded-lg bg-red-500/10 border border-red-500/30 text-red-400 text-sm text-center">
                        üî¥ Crit√®res insuffisants - SKIP
                    </div>
                `;
            }

            // ===== PATTERNS =====
            if (zoneCheck && zoneCheck.isOptimal) {
                document.getElementById('optimalZone').innerHTML = `
                    <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/30">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-xl">üéØ</span>
                            <span class="font-bold text-green-400">${zoneCheck.name}</span>
                        </div>
                        <div class="text-xs text-gray-300 space-y-1">
                            <div>‚Ä¢ Win rate: ${zoneCheck.winRate}</div>
                            <div>‚Ä¢ Gain moyen: ${zoneCheck.avgGain}</div>
                        </div>
                    </div>
                `;
            }

            const patterns = [];
            if (alertHistory.length >= 3) {
                const retracement = detectRetracement(previousAlerts);
                if (retracement && retracement.detected) {
                    patterns.push(`<span class="badge badge-success">‚ö° Pattern Retracement (+${retracement.expectedGain}%)</span>`);
                }
            }
            if (alertHistory.length >= 5) {
                patterns.push(`<span class="badge badge-warning">üî• Alertes Multiples (√ó${alertHistory.length})</span>`);
            }
            if (patterns.length > 0) {
                document.getElementById('patterns').innerHTML = `<div class="flex flex-wrap gap-2">${patterns.join('')}</div>`;
            }

            const bullishSignals = detectUltraBullishSignals(alert, alertHistory.length);
            if (bullishSignals.length >= 3) {
                document.getElementById('bullishSignals').innerHTML = `
                    <div class="p-4 rounded-lg bg-purple-500/10 border border-purple-500/30">
                        <div class="font-bold text-purple-400 mb-2">üöÄ Signaux Ultra-Bullish (${bullishSignals.length})</div>
                        <div class="text-xs text-gray-300 space-y-1">
                            ${bullishSignals.map(s => `<div>‚Ä¢ ${s}</div>`).join('')}
                        </div>
                    </div>
                `;
            }

            // Score breakdown
            document.getElementById('autoScore').textContent = autoScore;
            document.getElementById('breakdownList').innerHTML = breakdown.map(item => `
                <div class="flex items-center justify-between p-2 rounded ${item.highlight ? 'bg-purple-900/20' : 'bg-gray-900/20'}">
                    <span class="text-sm">${item.label}</span>
                    <span class="font-bold text-purple-400">+${item.points}</span>
                </div>
            `).join('');

            // ===== CHART =====
            const poolAddress = fullData.token_address || alert.pool_address;
            if (network && poolAddress) {
                const chartUrl = `https://www.geckoterminal.com/${network.toLowerCase()}/pools/${poolAddress}?embed=1&info=0&swaps=0`;
                document.getElementById('chartContainer').innerHTML = `
                    <iframe src="${chartUrl}" width="100%" height="500" frameborder="0" allow="clipboard-write" allowfullscreen></iframe>
                `;
                document.getElementById('geckoLink').href = `https://www.geckoterminal.com/${network.toLowerCase()}/pools/${poolAddress}`;
            } else {
                document.getElementById('chartContainer').innerHTML = `
                    <div class="text-center text-gray-400 py-12">Graphique non disponible</div>
                `;
            }

            // ===== KEY METRICS =====
            document.getElementById('liquidity').textContent = (alert.liquidity || fullData.liquidity) ? '$' + formatNumber(alert.liquidity || fullData.liquidity) : 'N/A';
            document.getElementById('volume24h').textContent = fullData.volume_24h ? '$' + formatNumber(fullData.volume_24h) : 'N/A';

            const volLiqRatio = (fullData.volume_24h && alert.liquidity) ? ((fullData.volume_24h / alert.liquidity) * 100).toFixed(0) + '%' : 'N/A';
            document.getElementById('volLiqRatio').textContent = volLiqRatio;

            document.getElementById('velocity').textContent = (fullData.velocite_pump || 0).toFixed(1) + 'x';
            document.getElementById('accel1h').textContent = fullData.volume_acceleration_1h_vs_6h ? fullData.volume_acceleration_1h_vs_6h.toFixed(2) + 'x' : 'N/A';
            document.getElementById('accel6h').textContent = fullData.volume_acceleration_6h_vs_24h ? fullData.volume_acceleration_6h_vs_24h.toFixed(2) + 'x' : 'N/A';

            document.getElementById('buys').textContent = fullData.buys_24h || 'N/A';
            document.getElementById('sells').textContent = fullData.sells_24h || 'N/A';
            document.getElementById('buyRatio').textContent = fullData.buy_ratio ? (fullData.buy_ratio * 100).toFixed(1) + '%' : 'N/A';

            // ===== RAW DATA =====
            document.getElementById('rawData').textContent = JSON.stringify({ alert, fullData }, null, 2);
        }

        function renderTimeline(alerts) {
            const sorted = [...alerts].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            document.getElementById('timelineList').innerHTML = sorted.map((alert, idx) => {
                const fullData = alert.full_data || {};
                const isLatest = idx === 0;

                return `
                    <div class="p-4 rounded-lg border ${isLatest ? 'border-orange-500 bg-orange-500/5' : 'border-gray-700'} hover:bg-white/5 transition">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-lg font-bold ${getScoreColor(alert.score)}">${alert.score}</span>
                                <span class="badge badge-info">${alert.tier}</span>
                                ${isLatest ? '<span class="badge badge-warning">DERNI√àRE</span>' : ''}
                            </div>
                            <span class="text-sm text-gray-400">${formatDate(alert.created_at)}</span>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                            <div>
                                <div class="text-gray-500 text-xs">Liquidit√©</div>
                                <div class="font-semibold text-green-400">${alert.liquidity ? '$' + formatNumber(alert.liquidity) : 'N/A'}</div>
                            </div>
                            <div>
                                <div class="text-gray-500 text-xs">Volume 24h</div>
                                <div class="font-semibold">${alert.volume_24h ? '$' + formatNumber(alert.volume_24h) : 'N/A'}</div>
                            </div>
                            <div>
                                <div class="text-gray-500 text-xs">Prix</div>
                                <div class="font-semibold text-blue-400">${fullData.entry_price ? formatPrice(fullData.entry_price) : 'N/A'}</div>
                            </div>
                            <div>
                                <div class="text-gray-500 text-xs">Age</div>
                                <div class="font-semibold">${getFreshnessDisplay(alert.age_hours || 0)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderCharts(alerts) {
            const sorted = [...alerts].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

            const labels = sorted.map(a => {
                const date = new Date(a.created_at);
                return date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
            });

            // Liquidity Chart
            const liqCtx = document.getElementById('liquidityChart');
            if (liquidityChart) liquidityChart.destroy();

            liquidityChart = new Chart(liqCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Liquidit√©',
                        data: sorted.map(a => a.liquidity || 0),
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: getChartOptions('$')
            });

            // Score Chart
            const scoreCtx = document.getElementById('scoreChart');
            if (scoreChart) scoreChart.destroy();

            scoreChart = new Chart(scoreCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Score',
                        data: sorted.map(a => a.score || 0),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: getChartOptions('')
            });
        }

        function getChartOptions(prefix = '') {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        padding: 12,
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 13 },
                        callbacks: {
                            label: (context) => prefix + formatNumber(context.parsed.y)
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        ticks: {
                            color: 'rgba(255,255,255,0.8)',
                            callback: (value) => prefix + formatNumber(value)
                        }
                    },
                    x: {
                        grid: { display: false },
                        ticks: {
                            color: 'rgba(255,255,255,0.8)',
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            };
        }

        // ===== ADD TO PORTFOLIO =====
        async function addToPortfolio() {
            if (!currentAlert) {
                showMessage('Erreur: Donn√©es non charg√©es', 'error');
                return;
            }

            const btn = document.getElementById('addToPortfolioBtn');
            btn.disabled = true;
            btn.textContent = 'Ajout en cours...';

            try {
                const fullData = currentAlert.full_data || {};

                const response = await fetch(`${API_URL}/portfolio`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        alert_id: parseInt(alertId),
                        pool_address: currentAlert.pool_address,
                        network: currentAlert.network,
                        token_symbol: currentAlert.token_symbol,
                        token_name: currentAlert.token_name,
                        entry_price: fullData.entry_price || currentAlert.price,
                        tp1_price: fullData.tp1_price,
                        tp2_price: fullData.tp2_price,
                        tp3_price: fullData.tp3_price,
                        stop_loss_price: fullData.stop_loss_price,
                        notes: `Score: ${currentAlert.score} | Tier: ${currentAlert.tier}`
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('Position ajout√©e au portfolio!', 'success');
                    btn.textContent = '‚úì Ajout√©';
                    btn.className = 'px-6 py-3 bg-green-500/20 text-green-400 rounded-lg border border-green-500/30 font-semibold cursor-not-allowed';
                } else {
                    showMessage(`Erreur: ${result.error}`, 'error');
                    btn.disabled = false;
                    btn.textContent = '+ Ajouter au Portfolio';
                }
            } catch (error) {
                showMessage('Erreur r√©seau', 'error');
                btn.disabled = false;
                btn.textContent = '+ Ajouter au Portfolio';
            }
        }

        function showMessage(message, type) {
            const msgEl = document.getElementById('portfolioMessage');
            msgEl.className = `mt-4 p-3 rounded-lg ${type === 'success' ? 'bg-green-500/20 text-green-400 border border-green-500/30' : 'bg-red-500/20 text-red-400 border border-red-500/30'}`;
            msgEl.textContent = message;
            msgEl.classList.remove('hidden');
            setTimeout(() => msgEl.classList.add('hidden'), 5000);
        }

        // ===== UTILITIES =====
        function formatNumber(num) {
            if (num >= 1_000_000) return (num / 1_000_000).toFixed(2) + 'M';
            if (num >= 1_000) return (num / 1_000).toFixed(2) + 'K';
            return num.toFixed(0);
        }

        function formatPrice(price) {
            if (!price) return 'N/A';
            if (price >= 1) return '$' + price.toFixed(4);
            if (price >= 0.01) return '$' + price.toFixed(6);
            return '$' + price.toFixed(8);
        }

        function getFreshnessDisplay(ageHours) {
            const ageMinutes = ageHours * 60;
            let emoji, cssClass, text;

            if (ageMinutes < 5) {
                emoji = 'üî¥';
                cssClass = 'badge-danger';
                text = Math.floor(ageMinutes) + 'min';
            } else if (ageMinutes < 30) {
                emoji = 'üü°';
                cssClass = 'badge-warning';
                text = Math.floor(ageMinutes) + 'min';
            } else if (ageHours < 6) {
                emoji = 'üü¢';
                cssClass = 'badge-success';
                text = ageHours.toFixed(1) + 'h';
            } else {
                emoji = '‚ö™';
                cssClass = 'badge-info';
                text = ageHours.toFixed(1) + 'h';
            }

            return `<span class="badge ${cssClass}">${emoji} ${text}</span>`;
        }

        function getScoreColor(score) {
            if (score >= 95) return 'text-purple-400';
            if (score >= 85) return 'text-blue-400';
            if (score >= 75) return 'text-green-400';
            if (score >= 60) return 'text-yellow-400';
            return 'text-red-400';
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ===== NETWORK STRATEGIES =====
        const NETWORK_STRATEGIES = {
            'eth': {
                rules: [
                    { name: 'Score', target: '‚â• 90', check: (a) => a.score >= 90 },
                    { name: 'Liquidit√©', target: '$30K-$5M', check: (a) => a.liquidity >= 30000 && a.liquidity <= 5000000 },
                    { name: 'Volume 24h', target: '‚â• $30K', check: (a) => a.volume_24h >= 30000 },
                    { name: 'V√©locit√©', target: '‚â• 5x', check: (a) => (a.velocite_pump || 0) >= 5 },
                    { name: 'Age', target: '1-48h', check: (a) => a.age_hours >= 1 && a.age_hours <= 48 },
                    { name: 'BONUS', target: 'Score 98-100', check: (a) => a.score >= 98, bonus: true }
                ]
            },
            'solana': {
                rules: [
                    { name: 'Score', target: '‚â• 95', check: (a) => a.score >= 95 },
                    { name: 'Liquidit√©', target: '$30K-$2M', check: (a) => a.liquidity >= 30000 && a.liquidity <= 2000000 },
                    { name: 'Volume 24h', target: '‚â• $30K', check: (a) => a.volume_24h >= 30000 },
                    { name: 'V√©locit√©', target: '‚â• 5x', check: (a) => (a.velocite_pump || 0) >= 5 },
                    { name: 'Age', target: '1-48h', check: (a) => a.age_hours >= 1 && a.age_hours <= 48 },
                    { name: 'BONUS', target: 'Score 98-100', check: (a) => a.score >= 98, bonus: true }
                ]
            },
            'bsc': {
                rules: [
                    { name: 'Score', target: '‚â• 95', check: (a) => a.score >= 95 },
                    { name: 'Liquidit√©', target: '$30K-$50M', check: (a) => a.liquidity >= 30000 && a.liquidity <= 50000000 },
                    { name: 'Volume 24h', target: '‚â• $50K', check: (a) => a.volume_24h >= 50000 },
                    { name: 'V√©locit√©', target: '‚â• 5x', check: (a) => (a.velocite_pump || 0) >= 5 },
                    { name: 'Age', target: '1-48h', check: (a) => a.age_hours >= 1 && a.age_hours <= 48 },
                    { name: 'BONUS', target: 'Score 98-100', check: (a) => a.score >= 98, bonus: true }
                ]
            },
            'base': {
                rules: [
                    { name: 'Score', target: '‚â• 90', check: (a) => a.score >= 90 },
                    { name: 'Liquidit√©', target: '$30K-$5M', check: (a) => a.liquidity >= 30000 && a.liquidity <= 5000000 },
                    { name: 'Volume 24h', target: '‚â• $30K', check: (a) => a.volume_24h >= 30000 },
                    { name: 'V√©locit√©', target: '‚â• 7x', check: (a) => (a.velocite_pump || 0) >= 7 },
                    { name: 'Age', target: '1-48h', check: (a) => a.age_hours >= 1 && a.age_hours <= 48 },
                    { name: 'BONUS', target: 'Score 98-100', check: (a) => a.score >= 98, bonus: true }
                ]
            },
            'arbitrum': {
                rules: [
                    { name: 'Score', target: '‚â• 98', check: (a) => a.score >= 98 },
                    { name: 'Liquidit√©', target: '$30K-$5M', check: (a) => a.liquidity >= 30000 && a.liquidity <= 5000000 },
                    { name: 'Volume 24h', target: '‚â• $30K', check: (a) => a.volume_24h >= 30000 },
                    { name: 'V√©locit√©', target: '‚â• 5x', check: (a) => (a.velocite_pump || 0) >= 5 },
                    { name: 'Age', target: '1-48h', check: (a) => a.age_hours >= 1 && a.age_hours <= 48 },
                    { name: 'BONUS', target: 'Score 98-100', check: (a) => a.score >= 98, bonus: true }
                ]
            }
        };

        function generateChecklist(alert, zoneCheck) {
            const network = (alert.network || '').toLowerCase();
            const strategy = NETWORK_STRATEGIES[network] || NETWORK_STRATEGIES['eth'];

            const ruleResults = strategy.rules.map(rule => ({
                ...rule,
                passed: rule.check(alert)
            }));

            const criticalRules = ruleResults.filter(r => !r.bonus);
            const bonusRules = ruleResults.filter(r => r.bonus);

            const items = [];

            for (const rule of criticalRules) {
                let currentValue = '';

                if (rule.name === 'Score') currentValue = `${alert.score}/100`;
                else if (rule.name === 'V√©locit√©') currentValue = `${(alert.velocite_pump || 0).toFixed(1)}x`;
                else if (rule.name === 'Liquidit√©') currentValue = `$${formatNumber(alert.liquidity || 0)}`;
                else if (rule.name === 'Volume 24h') currentValue = `$${formatNumber(alert.volume_24h || 0)}`;
                else if (rule.name === 'Age') {
                    const ageH = alert.age_hours || 0;
                    currentValue = ageH < 1 ? `${Math.floor(ageH * 60)}min` : `${ageH.toFixed(1)}h`;
                }

                items.push({
                    label: `${rule.name}: ${rule.target}`,
                    value: `Actuel: ${currentValue} ${rule.passed ? '‚úì' : '‚úó'}`,
                    passed: rule.passed,
                    isBonus: false
                });
            }

            for (const rule of bonusRules) {
                items.push({
                    label: `${rule.name}: ${rule.target}`,
                    value: rule.passed ? 'üöÄ BONUS ACTIV√â!' : 'Bonus non atteint',
                    passed: rule.passed,
                    isBonus: true
                });
            }

            return {
                items,
                passed: criticalRules.filter(r => r.passed).length,
                total: criticalRules.length,
                hasBonus: bonusRules.length > 0 && bonusRules[0].passed
            };
        }

        function getFinalRecommendation(score, checklistRatio, checklistPassed, checklistTotal) {
            if (checklistRatio < 0.6) {
                return {
                    action: 'üî¥ SKIP',
                    position: '0% capital',
                    confidence: 'Crit√®res insuffisants'
                };
            } else if (checklistRatio < 1.0) {
                if (score >= 85) {
                    return {
                        action: 'üü° BUY (Prudent)',
                        position: '3-5% capital',
                        confidence: `${Math.round(checklistRatio * 100)}% crit√®res (${checklistPassed}/${checklistTotal})`
                    };
                } else {
                    return {
                        action: '‚ö†Ô∏è PRUDENT',
                        position: '3% capital max',
                        confidence: `${Math.round(checklistRatio * 100)}% crit√®res (${checklistPassed}/${checklistTotal})`
                    };
                }
            } else {
                if (score >= 95) {
                    return {
                        action: 'üü¢ STRONG BUY',
                        position: '10% capital',
                        confidence: '95%+'
                    };
                } else if (score >= 85) {
                    return {
                        action: 'üü¢ BUY',
                        position: '7% capital',
                        confidence: '85%+'
                    };
                } else if (score >= 70) {
                    return {
                        action: 'üü° BUY (Mod√©r√©)',
                        position: '5% capital',
                        confidence: '70%+'
                    };
                } else {
                    return {
                        action: 'üî¥ SKIP',
                        position: '0% capital',
                        confidence: 'Score trop faible'
                    };
                }
            }
        }

        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', loadToken);
    </script>
</body>
</html>
