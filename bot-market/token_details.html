<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Details - Scanner V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: #0a0a0a;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .section {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 24px;
        }

        .data-row {
            display: flex;
            justify-between;
            padding: 12px 0;
            border-bottom: 1px solid #2a2a2a;
        }

        .data-row:last-child {
            border-bottom: none;
        }

        .data-label {
            color: #9ca3af;
            font-size: 14px;
        }

        .data-value {
            color: #fff;
            font-weight: 600;
            font-size: 14px;
        }

        .freshness-fresh { color: #ef4444; font-weight: 600; }
        .freshness-recent { color: #f59e0b; }
        .freshness-active { color: #22c55e; }
        .freshness-old { color: #6b7280; }

        iframe {
            border-radius: 12px;
        }
    </style>
</head>
<body class="text-white min-h-screen p-4 md:p-8">
    <!-- Header -->
    <div class="max-w-7xl mx-auto mb-6">
        <a href="javascript:history.back()" class="text-gray-400 hover:text-white transition text-sm inline-block mb-4">
            ‚Üê Retour
        </a>
        <div class="flex items-center justify-between flex-wrap gap-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold" id="tokenSymbol">-</h1>
                <p class="text-gray-400 mt-1" id="tokenName">-</p>
            </div>
            <div class="text-right">
                <div class="text-4xl font-bold" id="score">-</div>
                <div class="text-sm text-gray-400" id="tier">-</div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="max-w-7xl mx-auto text-center py-12">
        <div class="text-gray-400">Chargement...</div>
    </div>

    <!-- Content -->
    <div id="content" class="max-w-7xl mx-auto" style="display: none;">
        <!-- Alert History Badge -->
        <div id="alertHistoryBadge" class="section mb-6" style="display: none;">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="text-orange-400 text-2xl">üìä</span>
                    <div>
                        <h3 class="text-lg font-bold text-orange-400">Alertes Multiples D√©tect√©es</h3>
                        <p class="text-sm text-gray-400">Ce token a √©t√© alert√© <span id="totalAlertsCount" class="font-bold text-orange-400">-</span> fois. Consultez l'√©volution ci-dessous.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div class="section mb-6">
            <h2 class="text-xl font-bold mb-4">üìà Graphique Prix (Temps R√©el)</h2>
            <div id="chartContainer" style="height: 500px;">
                <!-- GeckoTerminal iframe will be inserted here -->
            </div>
        </div>

        <!-- Timeline & Evolution Charts (only shown if multiple alerts) -->
        <div id="timelineSection" class="mb-6" style="display: none;">
            <!-- Evolution Charts -->
            <div class="space-y-6 mb-6">
                <!-- Liquidit√© & Volume en haut (plus important) -->
                <div class="section">
                    <h3 class="text-lg font-bold mb-4 text-green-400">üí∞ √âvolution Liquidit√© & Volume</h3>
                    <div style="height: 350px;">
                        <canvas id="liquidityEvolutionChart"></canvas>
                    </div>
                </div>

                <!-- Score en bas -->
                <div class="section">
                    <h3 class="text-lg font-bold mb-4 text-blue-400">üìä √âvolution du Score</h3>
                    <div style="height: 300px;">
                        <canvas id="scoreEvolutionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Timeline List -->
            <div class="section">
                <h3 class="text-lg font-bold mb-4 text-purple-400">üïí Historique Complet des Alertes</h3>
                <div id="timelineList" class="space-y-3">
                    <!-- Timeline items will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Prix & Targets -->
            <div class="section">
                <h3 class="text-lg font-bold mb-4 text-green-400">üí∞ Prix & Targets</h3>
                <div class="space-y-3">
                    <div class="data-row">
                        <span class="data-label">Prix Entry</span>
                        <span class="data-value text-blue-400" id="entry_price">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Stop Loss (-10%)</span>
                        <span class="data-value text-red-400" id="stop_loss">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">TP1 (+5%)</span>
                        <span class="data-value text-green-400" id="tp1">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">TP2 (+10%)</span>
                        <span class="data-value text-green-400" id="tp2">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">TP3 (+15%)</span>
                        <span class="data-value text-green-400" id="tp3">-</span>
                    </div>
                </div>
            </div>

            <!-- Volume -->
            <div class="section">
                <h3 class="text-lg font-bold mb-4 text-blue-400">üìä Volume</h3>
                <div class="space-y-3">
                    <div class="data-row">
                        <span class="data-label">Volume 24h</span>
                        <span class="data-value" id="volume_24h">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Volume 6h</span>
                        <span class="data-value" id="volume_6h">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Volume 1h</span>
                        <span class="data-value" id="volume_1h">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Acc√©l. 1h vs 6h</span>
                        <span class="data-value" id="accel_1h">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Acc√©l. 6h vs 24h</span>
                        <span class="data-value" id="accel_6h">-</span>
                    </div>
                </div>
            </div>

            <!-- Transactions -->
            <div class="section">
                <h3 class="text-lg font-bold mb-4 text-purple-400">üîÑ Transactions</h3>
                <div class="space-y-3">
                    <div class="data-row">
                        <span class="data-label">Buys 24h</span>
                        <span class="data-value text-green-400" id="buys">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Sells 24h</span>
                        <span class="data-value text-red-400" id="sells">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Buy Ratio</span>
                        <span class="data-value" id="buy_ratio">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Total Txns</span>
                        <span class="data-value" id="total_txns">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Second Row -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Scoring -->
            <div class="section">
                <h3 class="text-lg font-bold mb-4 text-yellow-400">‚≠ê Scoring</h3>
                <div class="space-y-3">
                    <div class="data-row">
                        <span class="data-label">Score Total</span>
                        <span class="data-value" id="score_total">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Score Base</span>
                        <span class="data-value" id="base_score">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Bonus Momentum</span>
                        <span class="data-value text-green-400" id="momentum_bonus">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Score S√©curit√©</span>
                        <span class="data-value" id="security_score">-</span>
                    </div>
                </div>
            </div>

            <!-- Risques -->
            <div class="section">
                <h3 class="text-lg font-bold mb-4 text-orange-400">‚ö†Ô∏è Risques</h3>
                <div class="space-y-3">
                    <div class="data-row">
                        <span class="data-label">√Çge du Token</span>
                        <span class="data-value" id="age">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Liquidit√©</span>
                        <span class="data-value text-green-400" id="liquidity">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">R√©seau</span>
                        <span class="data-value" id="network">-</span>
                    </div>
                </div>
            </div>

            <!-- Pump Analysis -->
            <div class="section">
                <h3 class="text-lg font-bold mb-4 text-red-400">üöÄ Analyse Pump</h3>
                <div class="space-y-3">
                    <div class="data-row">
                        <span class="data-label">V√©locit√© Pump</span>
                        <span class="data-value" id="velocite_pump">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Type Pump</span>
                        <span class="data-value" id="type_pump">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">TP Tracking</span>
                        <span class="data-value text-xs" id="tp_tracking">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert Message (Raw Telegram) -->
        <div class="section mb-6">
            <h3 class="text-lg font-bold mb-4">üì± Message Telegram (Brut)</h3>
            <pre class="text-sm text-gray-300 whitespace-pre-wrap font-mono bg-black/50 p-4 rounded" id="alert_message">-</pre>
        </div>

        <!-- Links -->
        <div class="section">
            <h3 class="text-lg font-bold mb-4">üîó Liens & Actions</h3>
            <div class="flex flex-wrap gap-4">
                <button id="addToPortfolioBtn" onclick="addToPortfolio()" class="px-4 py-2 bg-purple-500/20 text-purple-400 rounded hover:bg-purple-500/30 transition border border-purple-500/30 font-semibold">
                    + Ajouter au Portfolio
                </button>
                <a id="geckoLink" href="#" target="_blank" class="px-4 py-2 bg-green-500/20 text-green-400 rounded hover:bg-green-500/30 transition border border-green-500/30">
                    Voir sur GeckoTerminal ‚Üí
                </a>
                <button onclick="history.back()" class="px-4 py-2 bg-gray-500/20 text-gray-400 rounded hover:bg-gray-500/30 transition border border-gray-500/30">
                    ‚Üê Retour
                </button>
            </div>
            <div id="portfolioMessage" class="mt-4 hidden"></div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin + '/api';
        const urlParams = new URLSearchParams(window.location.search);
        const alertId = urlParams.get('id');

        let alertHistory = [];
        let scoreChart = null;
        let liquidityChart = null;

        async function loadToken() {
            if (!alertId) {
                document.getElementById('loading').innerHTML = '<div class="text-red-400">ID manquant</div>';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/alerts/${alertId}`);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                renderToken(data);

                // Load alert history for this token
                await loadAlertHistory(data.pool_address || data.token_address);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').innerHTML = `<div class="text-red-400">Erreur: ${error.message}</div>`;
            }
        }

        async function loadAlertHistory(poolAddress) {
            if (!poolAddress) return;

            try {
                const response = await fetch(`${API_URL}/alerts/token/${poolAddress}`);
                const data = await response.json();

                if (data.alerts && data.alerts.length > 1) {
                    alertHistory = data.alerts;

                    // Show badge and timeline
                    document.getElementById('alertHistoryBadge').style.display = 'block';
                    document.getElementById('totalAlertsCount').textContent = data.count;
                    document.getElementById('timelineSection').style.display = 'block';

                    // Render timeline and charts
                    renderTimeline(alertHistory);
                    renderEvolutionCharts(alertHistory);
                }
            } catch (error) {
                console.error('Error loading alert history:', error);
            }
        }

        function renderTimeline(alerts) {
            const container = document.getElementById('timelineList');

            // Sort by date descending (newest first)
            const sortedAlerts = [...alerts].sort((a, b) =>
                new Date(b.created_at) - new Date(a.created_at)
            );

            container.innerHTML = sortedAlerts.map((alert, index) => {
                const fullData = alert.full_data || alert || {};
                const isLatest = index === 0;

                return `
                    <div class="border border-gray-700 rounded-lg p-4 hover:bg-white/5 transition ${isLatest ? 'border-orange-500/50 bg-orange-500/5' : ''}">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-bold text-lg ${getScoreColor(alert.score)}">${alert.score}</span>
                                    <span class="text-xs px-2 py-0.5 rounded ${getTierBadgeClass(alert.tier)}">${alert.tier}</span>
                                    ${isLatest ? '<span class="text-xs px-2 py-0.5 rounded bg-orange-500/20 text-orange-400 border border-orange-500/30">DERNI√àRE</span>' : ''}
                                </div>
                                <div class="text-sm text-gray-400">
                                    ${formatDate(alert.created_at)} ‚Ä¢ ${getFreshnessDisplay(alert.age_hours || 0)}
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                            <div>
                                <div class="text-gray-500 text-xs">Prix</div>
                                <div class="font-semibold text-blue-400">${fullData.entry_price ? '$' + fullData.entry_price.toFixed(8) : 'N/A'}</div>
                            </div>
                            <div>
                                <div class="text-gray-500 text-xs">Liquidit√©</div>
                                <div class="font-semibold text-green-400">${(alert.liquidity || fullData.liquidity) ? '$' + formatNumber(alert.liquidity || fullData.liquidity) : 'N/A'}</div>
                            </div>
                            <div>
                                <div class="text-gray-500 text-xs">Volume 24h</div>
                                <div class="font-semibold">${(alert.volume_24h || fullData.volume_24h) ? '$' + formatNumber(alert.volume_24h || fullData.volume_24h) : 'N/A'}</div>
                            </div>
                            <div>
                                <div class="text-gray-500 text-xs">TP1</div>
                                <div class="font-semibold text-green-400">${fullData.tp1_price ? '$' + fullData.tp1_price.toFixed(8) : 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderEvolutionCharts(alerts) {
            // Sort by date ascending (oldest first for charts)
            const sortedAlerts = [...alerts].sort((a, b) =>
                new Date(a.created_at) - new Date(b.created_at)
            );

            // Format labels to be more compact
            const labels = sortedAlerts.map(a => {
                const date = new Date(a.created_at);
                return date.toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            });

            const scores = sortedAlerts.map(a => a.score);
            const liquidities = sortedAlerts.map(a => (a.liquidity || a.full_data?.liquidity || 0));
            const volumes = sortedAlerts.map(a => (a.volume_24h || a.full_data?.volume_24h || 0));

            // Score Evolution Chart
            const scoreCtx = document.getElementById('scoreEvolutionChart');
            if (scoreChart) scoreChart.destroy();

            scoreChart = new Chart(scoreCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Score',
                        data: scores,
                        borderColor: 'rgba(59, 130, 246, 1)',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: scores.map(s => getScoreColorRGBA(s)),
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: 'rgba(255,255,255,0.9)',
                                font: { size: 14, weight: 'bold' }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1,
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 50,
                            max: 100,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: {
                                color: 'rgba(255,255,255,0.8)',
                                font: { size: 12 }
                            },
                            title: {
                                display: true,
                                text: 'Score',
                                color: 'rgba(255,255,255,0.9)',
                                font: { size: 13, weight: 'bold' }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: 'rgba(255,255,255,0.8)',
                                font: { size: 11 },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });

            // Liquidity & Volume Evolution Chart
            const liquidityCtx = document.getElementById('liquidityEvolutionChart');
            if (liquidityChart) liquidityChart.destroy();

            liquidityChart = new Chart(liquidityCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Liquidit√©',
                            data: liquidities,
                            borderColor: 'rgba(34, 197, 94, 1)',
                            backgroundColor: 'rgba(34, 197, 94, 0.2)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y',
                            pointBackgroundColor: 'rgba(34, 197, 94, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            borderWidth: 3
                        },
                        {
                            label: 'Volume 24h',
                            data: volumes,
                            borderColor: 'rgba(168, 85, 247, 1)',
                            backgroundColor: 'rgba(168, 85, 247, 0.2)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y',
                            pointBackgroundColor: 'rgba(168, 85, 247, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            borderWidth: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: 'rgba(255,255,255,0.9)',
                                font: { size: 14, weight: 'bold' },
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(34, 197, 94, 1)',
                            borderWidth: 1,
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += '$' + formatNumber(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: {
                                color: 'rgba(255,255,255,0.8)',
                                font: { size: 12 },
                                callback: function(value) {
                                    return '$' + formatNumber(value);
                                }
                            },
                            title: {
                                display: true,
                                text: 'Montant (USD)',
                                color: 'rgba(255,255,255,0.9)',
                                font: { size: 13, weight: 'bold' }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: 'rgba(255,255,255,0.8)',
                                font: { size: 11 },
                                maxRotation: 45,
                                minRotation: 45
                            },
                            title: {
                                display: true,
                                text: 'Date',
                                color: 'rgba(255,255,255,0.9)',
                                font: { size: 13, weight: 'bold' }
                            }
                        }
                    }
                }
            });
        }

        function getScoreColorRGBA(score) {
            if (score >= 95) return 'rgba(168, 85, 247, 1)'; // purple
            if (score >= 85) return 'rgba(59, 130, 246, 1)'; // blue
            if (score >= 75) return 'rgba(34, 197, 94, 1)'; // green
            if (score >= 60) return 'rgba(234, 179, 8, 1)'; // yellow
            return 'rgba(239, 68, 68, 1)'; // red
        }

        function getTierBadgeClass(tier) {
            const badges = {
                'ULTRA_HIGH': 'bg-purple-500/20 text-purple-400 border border-purple-500/30',
                'HIGH': 'bg-blue-500/20 text-blue-400 border border-blue-500/30',
                'MEDIUM': 'bg-green-500/20 text-green-400 border border-green-500/30',
                'LOW': 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30'
            };
            return badges[tier] || 'bg-gray-500/20 text-gray-400';
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function renderToken(alert) {
            // Store alert data for portfolio button
            currentAlertData = alert;

            // Hide loading, show content
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';

            // Header
            document.getElementById('tokenSymbol').textContent = alert.token_symbol || 'N/A';
            document.getElementById('tokenName').textContent = alert.token_name || 'N/A';
            document.getElementById('score').textContent = alert.score || 0;
            document.getElementById('score').className = `text-4xl font-bold ${getScoreColor(alert.score || 0)}`;
            document.getElementById('tier').textContent = alert.tier || 'N/A';

            // Get full data from alert_data JSON
            const fullData = alert.full_data || alert || {};

            // Prix & Targets
            document.getElementById('entry_price').textContent = fullData.entry_price ? `$${fullData.entry_price.toFixed(8)}` : 'N/A';
            document.getElementById('stop_loss').textContent = fullData.stop_loss_price ? `$${fullData.stop_loss_price.toFixed(8)}` : 'N/A';
            document.getElementById('tp1').textContent = fullData.tp1_price ? `$${fullData.tp1_price.toFixed(8)}` : 'N/A';
            document.getElementById('tp2').textContent = fullData.tp2_price ? `$${fullData.tp2_price.toFixed(8)}` : 'N/A';
            document.getElementById('tp3').textContent = fullData.tp3_price ? `$${fullData.tp3_price.toFixed(8)}` : 'N/A';

            // Volume
            document.getElementById('volume_24h').textContent = fullData.volume_24h ? `$${formatNumber(fullData.volume_24h)}` : 'N/A';
            document.getElementById('volume_6h').textContent = fullData.volume_6h ? `$${formatNumber(fullData.volume_6h)}` : 'N/A';
            document.getElementById('volume_1h').textContent = fullData.volume_1h ? `$${formatNumber(fullData.volume_1h)}` : 'N/A';
            document.getElementById('accel_1h').textContent = fullData.volume_acceleration_1h_vs_6h ? `${fullData.volume_acceleration_1h_vs_6h.toFixed(2)}x` : 'N/A';
            document.getElementById('accel_6h').textContent = fullData.volume_acceleration_6h_vs_24h ? `${fullData.volume_acceleration_6h_vs_24h.toFixed(2)}x` : 'N/A';

            // Transactions
            document.getElementById('buys').textContent = fullData.buys_24h || 'N/A';
            document.getElementById('sells').textContent = fullData.sells_24h || 'N/A';
            document.getElementById('buy_ratio').textContent = fullData.buy_ratio ? `${(fullData.buy_ratio * 100).toFixed(1)}%` : 'N/A';
            document.getElementById('total_txns').textContent = fullData.total_txns || 'N/A';

            // Scoring
            document.getElementById('score_total').textContent = fullData.score || alert.score || 'N/A';
            document.getElementById('base_score').textContent = fullData.base_score || 'N/A';
            document.getElementById('momentum_bonus').textContent = fullData.momentum_bonus ? `+${fullData.momentum_bonus}` : 'N/A';
            document.getElementById('security_score').textContent = fullData.confidence_score ? `${fullData.confidence_score}/100` : 'N/A';

            // Risques
            const ageHours = fullData.age_hours || alert.age_hours || 0;
            document.getElementById('age').innerHTML = getFreshnessDisplay(ageHours);
            document.getElementById('liquidity').textContent = (alert.liquidity || fullData.liquidity) ? `$${formatNumber(alert.liquidity || fullData.liquidity)}` : 'N/A';
            document.getElementById('network').textContent = (fullData.network || alert.network || '').toUpperCase();

            // Pump Analysis
            document.getElementById('velocite_pump').textContent = fullData.velocite_pump || 'N/A';
            document.getElementById('type_pump').textContent = fullData.type_pump || 'N/A';
            document.getElementById('tp_tracking').textContent = fullData.decision_tp_tracking || 'N/A';

            // Alert Message
            document.getElementById('alert_message').textContent = fullData.alert_message || 'Message non disponible';

            // GeckoTerminal Chart
            const network = (fullData.network || alert.network || '').toLowerCase();
            const poolAddress = fullData.token_address || alert.pool_address;

            if (network && poolAddress) {
                const chartUrl = `https://www.geckoterminal.com/${network}/pools/${poolAddress}?embed=1&info=0&swaps=0`;
                document.getElementById('chartContainer').innerHTML = `
                    <iframe
                        src="${chartUrl}"
                        width="100%"
                        height="500"
                        frameborder="0"
                        allow="clipboard-write"
                        allowfullscreen
                        style="border-radius: 12px;"
                    ></iframe>
                `;

                // Link
                document.getElementById('geckoLink').href = `https://www.geckoterminal.com/${network}/pools/${poolAddress}`;
            } else {
                document.getElementById('chartContainer').innerHTML = `
                    <div class="text-center text-gray-400 py-12">Graphique non disponible (adresse manquante)</div>
                `;
            }
        }

        // Utility functions
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
            return num.toFixed(0);
        }

        function getFreshnessDisplay(ageHours) {
            const ageMinutes = ageHours * 60;
            let emoji, cssClass, text;

            if (ageMinutes < 5) {
                emoji = 'üî¥';
                cssClass = 'freshness-fresh';
                text = Math.floor(ageMinutes) + 'min';
            } else if (ageMinutes < 30) {
                emoji = 'üü°';
                cssClass = 'freshness-recent';
                text = Math.floor(ageMinutes) + 'min';
            } else if (ageHours < 6) {
                emoji = 'üü¢';
                cssClass = 'freshness-active';
                text = ageHours.toFixed(1) + 'h';
            } else {
                emoji = '‚ö™';
                cssClass = 'freshness-old';
                text = ageHours.toFixed(1) + 'h';
            }

            return `<span class="${cssClass}">${emoji} ${text}</span>`;
        }

        function getScoreColor(score) {
            if (score >= 95) return 'text-purple-400';
            if (score >= 85) return 'text-blue-400';
            if (score >= 75) return 'text-green-400';
            if (score >= 60) return 'text-yellow-400';
            return 'text-red-400';
        }

        // Global variable to store current alert data
        let currentAlertData = null;

        // Add to Portfolio function
        async function addToPortfolio() {
            if (!currentAlertData) {
                showPortfolioMessage('Erreur: Donn√©es non charg√©es', 'error');
                return;
            }

            const btn = document.getElementById('addToPortfolioBtn');
            btn.disabled = true;
            btn.textContent = 'Ajout en cours...';

            try {
                const fullData = currentAlertData.full_data || {};

                const portfolioData = {
                    alert_id: parseInt(alertId),
                    pool_address: currentAlertData.pool_address,
                    network: currentAlertData.network,
                    token_symbol: currentAlertData.token_symbol,
                    token_name: currentAlertData.token_name,
                    entry_price: fullData.entry_price || currentAlertData.price,
                    tp1_price: fullData.tp1_price,
                    tp2_price: fullData.tp2_price,
                    tp3_price: fullData.tp3_price,
                    stop_loss_price: fullData.stop_loss_price,
                    notes: `Score: ${currentAlertData.score} | Tier: ${currentAlertData.tier}`
                };

                const response = await fetch(`${API_URL}/portfolio`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(portfolioData)
                });

                const result = await response.json();

                if (response.ok) {
                    showPortfolioMessage('Position ajout√©e au portfolio!', 'success');
                    btn.textContent = '‚úì Ajout√© au Portfolio';
                    btn.classList.remove('bg-purple-500/20', 'text-purple-400', 'border-purple-500/30');
                    btn.classList.add('bg-green-500/20', 'text-green-400', 'border-green-500/30');
                } else {
                    showPortfolioMessage(`Erreur: ${result.error}`, 'error');
                    btn.disabled = false;
                    btn.textContent = '+ Ajouter au Portfolio';
                }

            } catch (error) {
                console.error('Error adding to portfolio:', error);
                showPortfolioMessage('Erreur r√©seau', 'error');
                btn.disabled = false;
                btn.textContent = '+ Ajouter au Portfolio';
            }
        }

        // Show portfolio message
        function showPortfolioMessage(message, type) {
            const msgEl = document.getElementById('portfolioMessage');
            msgEl.className = `mt-4 p-3 rounded ${type === 'success' ? 'bg-green-500/20 text-green-400 border border-green-500/30' : 'bg-red-500/20 text-red-400 border border-red-500/30'}`;
            msgEl.textContent = message;
            msgEl.classList.remove('hidden');

            setTimeout(() => {
                msgEl.classList.add('hidden');
            }, 5000);
        }

        // Init
        document.addEventListener('DOMContentLoaded', loadToken);
    </script>
</body>
</html>
