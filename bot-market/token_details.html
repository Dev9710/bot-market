<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Details - Scanner V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="trading_strategy.js"></script>
    <style>
        body {
            background: #0a0a0a;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .section {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 24px;
        }

        .data-row {
            display: flex;
            justify-between;
            padding: 12px 0;
            border-bottom: 1px solid #2a2a2a;
        }

        .data-row:last-child {
            border-bottom: none;
        }

        .data-label {
            color: #9ca3af;
            font-size: 14px;
        }

        .data-value {
            color: #fff;
            font-weight: 600;
            font-size: 14px;
        }

        .freshness-fresh { color: #ef4444; font-weight: 600; }
        .freshness-recent { color: #f59e0b; }
        .freshness-active { color: #22c55e; }
        .freshness-old { color: #6b7280; }

        iframe {
            border-radius: 12px;
        }

        /* Strategy Sections */
        .strategy-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #1f1f1f 100%);
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 20px;
        }

        .strategy-card.optimal {
            border-color: #22c55e;
            background: linear-gradient(135deg, #1a1a1a 0%, #1a2e1f 100%);
        }

        .strategy-card.strong-buy {
            border-color: #8b5cf6;
            background: linear-gradient(135deg, #1a1a1a 0%, #1f1a2e 100%);
        }

        .strategy-card.warning {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #1a1a1a 0%, #2e251a 100%);
        }

        .score-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 18px;
        }

        .score-badge.excellent {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .score-badge.good {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .score-badge.medium {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .score-badge.low {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 8px;
            background: #0a0a0a;
            margin-bottom: 8px;
        }

        .checklist-item.passed {
            background: #1a2e1f;
            border-left: 3px solid #22c55e;
        }

        .checklist-item.failed {
            background: #2e1a1a;
            border-left: 3px solid #ef4444;
        }

        .target-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #0a0a0a;
        }

        .target-line.sl {
            border-left: 3px solid #ef4444;
        }

        .target-line.tp {
            border-left: 3px solid #22c55e;
        }

        .breakdown-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #0a0a0a;
            border-radius: 6px;
            margin-bottom: 4px;
            font-size: 13px;
        }

        .breakdown-item.highlight {
            background: linear-gradient(135deg, #1f1a2e 0%, #1a1a1a 100%);
            border-left: 2px solid #8b5cf6;
        }

        .pattern-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .pattern-badge.detected {
            background: #1a2e1f;
            color: #22c55e;
            border: 1px solid #22c55e40;
        }
    </style>
</head>
<body class="text-white min-h-screen p-4 md:p-8">
    <!-- Header -->
    <div class="max-w-7xl mx-auto mb-6">
        <a href="javascript:history.back()" class="text-gray-400 hover:text-white transition text-sm inline-block mb-4">
            ‚Üê Retour
        </a>
        <div class="flex items-center justify-between flex-wrap gap-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold" id="tokenSymbol">-</h1>
                <p class="text-gray-400 mt-1" id="tokenName">-</p>
            </div>
            <div class="text-right">
                <div class="text-4xl font-bold" id="score">-</div>
                <div class="text-sm text-gray-400" id="tier">-</div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="max-w-7xl mx-auto text-center py-12">
        <div class="text-gray-400">Chargement...</div>
    </div>

    <!-- Content -->
    <div id="content" class="max-w-7xl mx-auto" style="display: none;">
        <!-- Alert History Badge -->
        <div id="alertHistoryBadge" class="section mb-6" style="display: none;">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="text-orange-400 text-2xl">üìä</span>
                    <div>
                        <h3 class="text-lg font-bold text-orange-400">Alertes Multiples D√©tect√©es</h3>
                        <p class="text-sm text-gray-400">Ce token a √©t√© alert√© <span id="totalAlertsCount" class="font-bold text-orange-400">-</span> fois. Consultez l'√©volution ci-dessous.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============ STRAT√âGIE & SIGNAUX ============ -->

        <!-- Signal Analysis -->
        <div id="signalAnalysis" class="mb-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Score Auto & Recommandation -->
                <div class="strategy-card" id="signalCard">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <span>üéØ</span>
                        <span>Analyse du Signal</span>
                    </h3>

                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <div class="text-sm text-gray-400 mb-1">Score Auto</div>
                            <div id="autoScore" class="score-badge excellent">95/100</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-400 mb-1">Action</div>
                            <div id="recommendation" class="text-2xl font-bold text-purple-400">üü¢ STRONG BUY</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <div class="text-xs text-gray-400 mb-1">Position Recommand√©e</div>
                            <div id="positionRec" class="text-lg font-bold text-green-400">10% capital</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-400 mb-1">Confiance</div>
                            <div id="confidence" class="text-lg font-bold text-blue-400">95%+</div>
                        </div>
                    </div>

                    <!-- Breakdown (collapsible) -->
                    <div>
                        <button onclick="toggleBreakdown()" class="text-sm text-gray-400 hover:text-white transition flex items-center gap-2 mb-2">
                            <span id="breakdownIcon">‚ñ∂</span>
                            <span>D√©tails du scoring</span>
                        </button>
                        <div id="breakdownList" style="display: none;" class="space-y-1 mt-2">
                            <!-- Breakdown items will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Zone Optimale & Patterns -->
                <div class="strategy-card" id="patternsCard">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <span>üîç</span>
                        <span>Patterns D√©tect√©s</span>
                    </h3>

                    <!-- Zone optimale -->
                    <div id="optimalZone" class="mb-4">
                        <!-- Will be populated -->
                    </div>

                    <!-- Patterns badges -->
                    <div id="patternsList" class="flex flex-wrap gap-2 mb-4">
                        <!-- Pattern badges will be inserted here -->
                    </div>

                    <!-- Ultra-bullish signals -->
                    <div id="bullishSignals">
                        <!-- Will be populated if applicable -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Targets Dynamiques & Checklist -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Targets Dynamiques -->
            <div class="strategy-card">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <span>üéØ</span>
                    <span>Targets Dynamiques</span>
                    <span class="text-xs text-gray-400 font-normal">(Recalcul√©s selon alertes)</span>
                </h3>

                <div class="space-y-2 mb-4">
                    <div class="target-line" style="background: #1a1a2e; border-left: 3px solid #8b5cf6;">
                        <span class="text-sm text-gray-300">Entry Price</span>
                        <span id="dynamicEntry" class="font-bold text-blue-400">-</span>
                    </div>

                    <div class="target-line sl">
                        <span class="text-sm text-gray-300">üõ°Ô∏è Stop Loss</span>
                        <span id="dynamicSL" class="font-bold text-red-400">-</span>
                    </div>

                    <div class="target-line tp">
                        <span class="text-sm text-gray-300">TP1</span>
                        <span id="dynamicTP1" class="font-bold text-green-400">-</span>
                    </div>

                    <div class="target-line tp">
                        <span class="text-sm text-gray-300">TP2</span>
                        <span id="dynamicTP2" class="font-bold text-green-400">-</span>
                    </div>

                    <div class="target-line tp">
                        <span class="text-sm text-gray-300">TP3</span>
                        <span id="dynamicTP3" class="font-bold text-green-400">-</span>
                    </div>

                    <div class="target-line" style="background: #1a1a2e; border-left: 3px solid #f59e0b;">
                        <span class="text-sm text-gray-300">üìä Trail Stop</span>
                        <span id="dynamicTS" class="font-bold text-yellow-400">-</span>
                    </div>
                </div>

                <!-- Reasoning -->
                <div>
                    <div class="text-xs text-gray-400 mb-2">üí° Raisonnement:</div>
                    <div id="targetReasoning" class="text-xs text-gray-400 space-y-1">
                        <!-- Reasoning items will be inserted here -->
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t border-gray-700">
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-400">Multiplicateur:</span>
                        <span id="multiplierValue" class="text-sm font-bold text-purple-400">-</span>
                    </div>
                    <div class="flex items-center justify-between mt-2">
                        <span class="text-xs text-gray-400">Risque:</span>
                        <span id="riskLevel" class="text-sm font-bold">-</span>
                    </div>
                </div>
            </div>

            <!-- Checklist Pr√©-Trade -->
            <div class="strategy-card" id="checklistCard">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <span>‚úÖ</span>
                    <span id="checklistNetworkTitle">Checklist Pr√©-Trade</span>
                </h3>

                <!-- Strategy Status Banner -->
                <div id="strategyStatusBanner" class="mb-4">
                    <!-- Status banner will be inserted here -->
                </div>

                <div id="checklistCriteria" class="space-y-2 mb-4">
                    <!-- Checklist items will be inserted here -->
                </div>

                <div class="mt-4 pt-4 border-t border-gray-700">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-300">Crit√®res valid√©s:</span>
                        <span id="checklistScore" class="font-bold text-lg">-</span>
                    </div>
                    <div id="checklistResult" class="mt-3">
                        <!-- Result message will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ============ FIN STRAT√âGIE ============ -->

        <!-- Chart -->
        <div class="section mb-6">
            <h2 class="text-xl font-bold mb-4">üìà Graphique Prix (Temps R√©el)</h2>
            <div id="chartContainer" style="height: 500px;">
                <!-- GeckoTerminal iframe will be inserted here -->
            </div>
        </div>

        <!-- Timeline & Evolution Charts (only shown if multiple alerts) -->
        <div id="timelineSection" class="mb-6" style="display: none;">
            <!-- Evolution Charts -->
            <div class="space-y-6 mb-6">
                <!-- Liquidit√© & Volume en haut (plus important) -->
                <div class="section">
                    <h3 class="text-lg font-bold mb-4 text-green-400">üí∞ √âvolution Liquidit√© & Volume</h3>
                    <div style="height: 350px;">
                        <canvas id="liquidityEvolutionChart"></canvas>
                    </div>
                </div>

                <!-- Score en bas -->
                <div class="section">
                    <h3 class="text-lg font-bold mb-4 text-blue-400">üìä √âvolution du Score</h3>
                    <div style="height: 300px;">
                        <canvas id="scoreEvolutionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Timeline List -->
            <div class="section">
                <h3 class="text-lg font-bold mb-4 text-purple-400">üïí Historique Complet des Alertes</h3>
                <div id="timelineList" class="space-y-3">
                    <!-- Timeline items will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Prix & Targets -->
            <div class="section">
                <h3 class="text-lg font-bold mb-4 text-green-400">üí∞ Prix & Targets</h3>
                <div class="space-y-3">
                    <div class="data-row">
                        <span class="data-label">Prix Entry</span>
                        <span class="data-value text-blue-400" id="entry_price">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Stop Loss (-10%)</span>
                        <span class="data-value text-red-400" id="stop_loss">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">TP1 (+5%)</span>
                        <span class="data-value text-green-400" id="tp1">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">TP2 (+10%)</span>
                        <span class="data-value text-green-400" id="tp2">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">TP3 (+15%)</span>
                        <span class="data-value text-green-400" id="tp3">-</span>
                    </div>
                </div>
            </div>

            <!-- Volume -->
            <div class="section">
                <h3 class="text-lg font-bold mb-4 text-blue-400">üìä Volume</h3>
                <div class="space-y-3">
                    <div class="data-row">
                        <span class="data-label">Volume 24h</span>
                        <span class="data-value" id="volume_24h">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Volume 6h</span>
                        <span class="data-value" id="volume_6h">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Volume 1h</span>
                        <span class="data-value" id="volume_1h">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Acc√©l. 1h vs 6h</span>
                        <span class="data-value" id="accel_1h">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Acc√©l. 6h vs 24h</span>
                        <span class="data-value" id="accel_6h">-</span>
                    </div>
                </div>
            </div>

            <!-- Transactions -->
            <div class="section">
                <h3 class="text-lg font-bold mb-4 text-purple-400">üîÑ Transactions</h3>
                <div class="space-y-3">
                    <div class="data-row">
                        <span class="data-label">Buys 24h</span>
                        <span class="data-value text-green-400" id="buys">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Sells 24h</span>
                        <span class="data-value text-red-400" id="sells">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Buy Ratio</span>
                        <span class="data-value" id="buy_ratio">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Total Txns</span>
                        <span class="data-value" id="total_txns">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Second Row -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Scoring -->
            <div class="section">
                <h3 class="text-lg font-bold mb-4 text-yellow-400">‚≠ê Scoring</h3>
                <div class="space-y-3">
                    <div class="data-row">
                        <span class="data-label">Score Total</span>
                        <span class="data-value" id="score_total">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Score Base</span>
                        <span class="data-value" id="base_score">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Bonus Momentum</span>
                        <span class="data-value text-green-400" id="momentum_bonus">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Score S√©curit√©</span>
                        <span class="data-value" id="security_score">-</span>
                    </div>
                </div>
            </div>

            <!-- Risques -->
            <div class="section">
                <h3 class="text-lg font-bold mb-4 text-orange-400">‚ö†Ô∏è Risques</h3>
                <div class="space-y-3">
                    <div class="data-row">
                        <span class="data-label">√Çge du Token</span>
                        <span class="data-value" id="age">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Liquidit√©</span>
                        <span class="data-value text-green-400" id="liquidity">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">R√©seau</span>
                        <span class="data-value" id="network">-</span>
                    </div>
                </div>
            </div>

            <!-- Pump Analysis -->
            <div class="section">
                <h3 class="text-lg font-bold mb-4 text-red-400">üöÄ Analyse Pump</h3>
                <div class="space-y-3">
                    <div class="data-row">
                        <span class="data-label">V√©locit√© Pump</span>
                        <span class="data-value" id="velocite_pump">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Type Pump</span>
                        <span class="data-value" id="type_pump">-</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">TP Tracking</span>
                        <span class="data-value text-xs" id="tp_tracking">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert Message (Raw Telegram) -->
        <div class="section mb-6">
            <h3 class="text-lg font-bold mb-4">üì± Message Telegram (Brut)</h3>
            <pre class="text-sm text-gray-300 whitespace-pre-wrap font-mono bg-black/50 p-4 rounded" id="alert_message">-</pre>
        </div>

        <!-- Links -->
        <div class="section">
            <h3 class="text-lg font-bold mb-4">üîó Liens & Actions</h3>
            <div class="flex flex-wrap gap-4">
                <button id="addToPortfolioBtn" onclick="addToPortfolio()" class="px-4 py-2 bg-purple-500/20 text-purple-400 rounded hover:bg-purple-500/30 transition border border-purple-500/30 font-semibold">
                    + Ajouter au Portfolio
                </button>
                <a id="geckoLink" href="#" target="_blank" class="px-4 py-2 bg-green-500/20 text-green-400 rounded hover:bg-green-500/30 transition border border-green-500/30">
                    Voir sur GeckoTerminal ‚Üí
                </a>
                <button onclick="history.back()" class="px-4 py-2 bg-gray-500/20 text-gray-400 rounded hover:bg-gray-500/30 transition border border-gray-500/30">
                    ‚Üê Retour
                </button>
            </div>
            <div id="portfolioMessage" class="mt-4 hidden"></div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin + '/api';
        const urlParams = new URLSearchParams(window.location.search);
        const alertId = urlParams.get('id');

        let alertHistory = [];
        let currentAlert = null; // Store current alert globally
        let scoreChart = null;
        let liquidityChart = null;

        async function loadToken() {
            if (!alertId) {
                document.getElementById('loading').innerHTML = '<div class="text-red-400">ID manquant</div>';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/alerts/${alertId}`);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                renderToken(data);

                // Load alert history for this token
                await loadAlertHistory(data.pool_address || data.token_address);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').innerHTML = `<div class="text-red-400">Erreur: ${error.message}</div>`;
            }
        }

        async function loadAlertHistory(poolAddress) {
            if (!poolAddress) return;

            try {
                const response = await fetch(`${API_URL}/alerts/token/${poolAddress}`);
                const data = await response.json();

                if (data.alerts && data.alerts.length > 1) {
                    alertHistory = data.alerts;

                    // Show badge and timeline
                    document.getElementById('alertHistoryBadge').style.display = 'block';
                    document.getElementById('totalAlertsCount').textContent = data.count;
                    document.getElementById('timelineSection').style.display = 'block';

                    // Render timeline and charts
                    renderTimeline(alertHistory);
                    renderEvolutionCharts(alertHistory);

                    // Populate strategy analysis with full alert history
                    const latestAlert = alertHistory[0] || currentAlert;
                    const previousAlerts = alertHistory.slice(1); // All alerts except latest
                    populateStrategyAnalysis(latestAlert, previousAlerts);
                } else {
                    // Single alert - populate strategy without history
                    populateStrategyAnalysis(currentAlert, []);
                }
            } catch (error) {
                console.error('Error loading alert history:', error);
                // Fallback to single alert analysis
                populateStrategyAnalysis(currentAlert, []);
            }
        }

        function renderTimeline(alerts) {
            const container = document.getElementById('timelineList');

            // Sort by date descending (newest first)
            const sortedAlerts = [...alerts].sort((a, b) =>
                new Date(b.created_at) - new Date(a.created_at)
            );

            container.innerHTML = sortedAlerts.map((alert, index) => {
                const fullData = alert.full_data || alert || {};
                const isLatest = index === 0;

                return `
                    <div class="border border-gray-700 rounded-lg p-4 hover:bg-white/5 transition ${isLatest ? 'border-orange-500/50 bg-orange-500/5' : ''}">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-bold text-lg ${getScoreColor(alert.score)}">${alert.score}</span>
                                    <span class="text-xs px-2 py-0.5 rounded ${getTierBadgeClass(alert.tier)}">${alert.tier}</span>
                                    ${isLatest ? '<span class="text-xs px-2 py-0.5 rounded bg-orange-500/20 text-orange-400 border border-orange-500/30">DERNI√àRE</span>' : ''}
                                </div>
                                <div class="text-sm text-gray-400">
                                    ${formatDate(alert.created_at)} ‚Ä¢ ${getFreshnessDisplay(alert.age_hours || 0)}
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                            <div>
                                <div class="text-gray-500 text-xs">Prix</div>
                                <div class="font-semibold text-blue-400">${fullData.entry_price ? '$' + fullData.entry_price.toFixed(8) : 'N/A'}</div>
                            </div>
                            <div>
                                <div class="text-gray-500 text-xs">Liquidit√©</div>
                                <div class="font-semibold text-green-400">${(alert.liquidity || fullData.liquidity) ? '$' + formatNumber(alert.liquidity || fullData.liquidity) : 'N/A'}</div>
                            </div>
                            <div>
                                <div class="text-gray-500 text-xs">Volume 24h</div>
                                <div class="font-semibold">${(alert.volume_24h || fullData.volume_24h) ? '$' + formatNumber(alert.volume_24h || fullData.volume_24h) : 'N/A'}</div>
                            </div>
                            <div>
                                <div class="text-gray-500 text-xs">TP1</div>
                                <div class="font-semibold text-green-400">${fullData.tp1_price ? '$' + fullData.tp1_price.toFixed(8) : 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderEvolutionCharts(alerts) {
            // Sort by date ascending (oldest first for charts)
            const sortedAlerts = [...alerts].sort((a, b) =>
                new Date(a.created_at) - new Date(b.created_at)
            );

            // Format labels to be more compact
            const labels = sortedAlerts.map(a => {
                const date = new Date(a.created_at);
                return date.toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            });

            const scores = sortedAlerts.map(a => a.score);
            const liquidities = sortedAlerts.map(a => (a.liquidity || a.full_data?.liquidity || 0));
            const volumes = sortedAlerts.map(a => (a.volume_24h || a.full_data?.volume_24h || 0));

            // Score Evolution Chart
            const scoreCtx = document.getElementById('scoreEvolutionChart');
            if (scoreChart) scoreChart.destroy();

            scoreChart = new Chart(scoreCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Score',
                        data: scores,
                        borderColor: 'rgba(59, 130, 246, 1)',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: scores.map(s => getScoreColorRGBA(s)),
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: 'rgba(255,255,255,0.9)',
                                font: { size: 14, weight: 'bold' }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1,
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 50,
                            max: 100,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: {
                                color: 'rgba(255,255,255,0.8)',
                                font: { size: 12 }
                            },
                            title: {
                                display: true,
                                text: 'Score',
                                color: 'rgba(255,255,255,0.9)',
                                font: { size: 13, weight: 'bold' }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: 'rgba(255,255,255,0.8)',
                                font: { size: 11 },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });

            // Liquidity & Volume Evolution Chart
            const liquidityCtx = document.getElementById('liquidityEvolutionChart');
            if (liquidityChart) liquidityChart.destroy();

            liquidityChart = new Chart(liquidityCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Liquidit√©',
                            data: liquidities,
                            borderColor: 'rgba(34, 197, 94, 1)',
                            backgroundColor: 'rgba(34, 197, 94, 0.2)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y',
                            pointBackgroundColor: 'rgba(34, 197, 94, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            borderWidth: 3
                        },
                        {
                            label: 'Volume 24h',
                            data: volumes,
                            borderColor: 'rgba(168, 85, 247, 1)',
                            backgroundColor: 'rgba(168, 85, 247, 0.2)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y',
                            pointBackgroundColor: 'rgba(168, 85, 247, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            borderWidth: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: 'rgba(255,255,255,0.9)',
                                font: { size: 14, weight: 'bold' },
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: 'rgba(34, 197, 94, 1)',
                            borderWidth: 1,
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += '$' + formatNumber(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: {
                                color: 'rgba(255,255,255,0.8)',
                                font: { size: 12 },
                                callback: function(value) {
                                    return '$' + formatNumber(value);
                                }
                            },
                            title: {
                                display: true,
                                text: 'Montant (USD)',
                                color: 'rgba(255,255,255,0.9)',
                                font: { size: 13, weight: 'bold' }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: 'rgba(255,255,255,0.8)',
                                font: { size: 11 },
                                maxRotation: 45,
                                minRotation: 45
                            },
                            title: {
                                display: true,
                                text: 'Date',
                                color: 'rgba(255,255,255,0.9)',
                                font: { size: 13, weight: 'bold' }
                            }
                        }
                    }
                }
            });
        }

        function getScoreColorRGBA(score) {
            if (score >= 95) return 'rgba(168, 85, 247, 1)'; // purple
            if (score >= 85) return 'rgba(59, 130, 246, 1)'; // blue
            if (score >= 75) return 'rgba(34, 197, 94, 1)'; // green
            if (score >= 60) return 'rgba(234, 179, 8, 1)'; // yellow
            return 'rgba(239, 68, 68, 1)'; // red
        }

        function getTierBadgeClass(tier) {
            const badges = {
                'ULTRA_HIGH': 'bg-purple-500/20 text-purple-400 border border-purple-500/30',
                'HIGH': 'bg-blue-500/20 text-blue-400 border border-blue-500/30',
                'MEDIUM': 'bg-green-500/20 text-green-400 border border-green-500/30',
                'LOW': 'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30'
            };
            return badges[tier] || 'bg-gray-500/20 text-gray-400';
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function renderToken(data) {
            // Store alert data globally
            currentAlert = data;
            currentAlertData = data;

            // Hide loading, show content
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';

            // Header
            document.getElementById('tokenSymbol').textContent = currentAlert.token_symbol || 'N/A';
            document.getElementById('tokenName').textContent = currentAlert.token_name || 'N/A';
            document.getElementById('score').textContent = currentAlert.score || 0;
            document.getElementById('score').className = `text-4xl font-bold ${getScoreColor(currentAlert.score || 0)}`;
            document.getElementById('tier').textContent = currentAlert.tier || 'N/A';

            // Get full data from alert_data JSON
            const fullData = currentAlert.full_data || currentAlert || {};

            // Prix & Targets
            document.getElementById('entry_price').textContent = fullData.entry_price ? `$${fullData.entry_price.toFixed(8)}` : 'N/A';
            document.getElementById('stop_loss').textContent = fullData.stop_loss_price ? `$${fullData.stop_loss_price.toFixed(8)}` : 'N/A';
            document.getElementById('tp1').textContent = fullData.tp1_price ? `$${fullData.tp1_price.toFixed(8)}` : 'N/A';
            document.getElementById('tp2').textContent = fullData.tp2_price ? `$${fullData.tp2_price.toFixed(8)}` : 'N/A';
            document.getElementById('tp3').textContent = fullData.tp3_price ? `$${fullData.tp3_price.toFixed(8)}` : 'N/A';

            // Volume
            document.getElementById('volume_24h').textContent = fullData.volume_24h ? `$${formatNumber(fullData.volume_24h)}` : 'N/A';
            document.getElementById('volume_6h').textContent = fullData.volume_6h ? `$${formatNumber(fullData.volume_6h)}` : 'N/A';
            document.getElementById('volume_1h').textContent = fullData.volume_1h ? `$${formatNumber(fullData.volume_1h)}` : 'N/A';
            document.getElementById('accel_1h').textContent = fullData.volume_acceleration_1h_vs_6h ? `${fullData.volume_acceleration_1h_vs_6h.toFixed(2)}x` : 'N/A';
            document.getElementById('accel_6h').textContent = fullData.volume_acceleration_6h_vs_24h ? `${fullData.volume_acceleration_6h_vs_24h.toFixed(2)}x` : 'N/A';

            // Transactions
            document.getElementById('buys').textContent = fullData.buys_24h || 'N/A';
            document.getElementById('sells').textContent = fullData.sells_24h || 'N/A';
            document.getElementById('buy_ratio').textContent = fullData.buy_ratio ? `${(fullData.buy_ratio * 100).toFixed(1)}%` : 'N/A';
            document.getElementById('total_txns').textContent = fullData.total_txns || 'N/A';

            // Scoring
            document.getElementById('score_total').textContent = fullData.score || currentAlert.score || 'N/A';
            document.getElementById('base_score').textContent = fullData.base_score || 'N/A';
            document.getElementById('momentum_bonus').textContent = fullData.momentum_bonus ? `+${fullData.momentum_bonus}` : 'N/A';
            document.getElementById('security_score').textContent = fullData.confidence_score ? `${fullData.confidence_score}/100` : 'N/A';

            // Risques
            const ageHours = fullData.age_hours || currentAlert.age_hours || 0;
            document.getElementById('age').innerHTML = getFreshnessDisplay(ageHours);
            document.getElementById('liquidity').textContent = (currentAlert.liquidity || fullData.liquidity) ? `$${formatNumber(currentAlert.liquidity || fullData.liquidity)}` : 'N/A';
            document.getElementById('network').textContent = (fullData.network || currentAlert.network || '').toUpperCase();

            // Pump Analysis
            document.getElementById('velocite_pump').textContent = fullData.velocite_pump || 'N/A';
            document.getElementById('type_pump').textContent = fullData.type_pump || 'N/A';
            document.getElementById('tp_tracking').textContent = fullData.decision_tp_tracking || 'N/A';

            // Alert Message
            document.getElementById('alert_message').textContent = fullData.alert_message || 'Message non disponible';

            // GeckoTerminal Chart
            const network = (fullData.network || currentAlert.network || '').toLowerCase();
            const poolAddress = fullData.token_address || currentAlert.pool_address;

            if (network && poolAddress) {
                const chartUrl = `https://www.geckoterminal.com/${network}/pools/${poolAddress}?embed=1&info=0&swaps=0`;
                document.getElementById('chartContainer').innerHTML = `
                    <iframe
                        src="${chartUrl}"
                        width="100%"
                        height="500"
                        frameborder="0"
                        allow="clipboard-write"
                        allowfullscreen
                        style="border-radius: 12px;"
                    ></iframe>
                `;

                // Link
                document.getElementById('geckoLink').href = `https://www.geckoterminal.com/${network}/pools/${poolAddress}`;
            } else {
                document.getElementById('chartContainer').innerHTML = `
                    <div class="text-center text-gray-400 py-12">Graphique non disponible (adresse manquante)</div>
                `;
            }
        }

        // Utility functions
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
            return num.toFixed(0);
        }

        function getFreshnessDisplay(ageHours) {
            const ageMinutes = ageHours * 60;
            let emoji, cssClass, text;

            if (ageMinutes < 5) {
                emoji = 'üî¥';
                cssClass = 'freshness-fresh';
                text = Math.floor(ageMinutes) + 'min';
            } else if (ageMinutes < 30) {
                emoji = 'üü°';
                cssClass = 'freshness-recent';
                text = Math.floor(ageMinutes) + 'min';
            } else if (ageHours < 6) {
                emoji = 'üü¢';
                cssClass = 'freshness-active';
                text = ageHours.toFixed(1) + 'h';
            } else {
                emoji = '‚ö™';
                cssClass = 'freshness-old';
                text = ageHours.toFixed(1) + 'h';
            }

            return `<span class="${cssClass}">${emoji} ${text}</span>`;
        }

        function getScoreColor(score) {
            if (score >= 95) return 'text-purple-400';
            if (score >= 85) return 'text-blue-400';
            if (score >= 75) return 'text-green-400';
            if (score >= 60) return 'text-yellow-400';
            return 'text-red-400';
        }

        // Global variable to store current alert data
        let currentAlertData = null;

        // Add to Portfolio function
        async function addToPortfolio() {
            if (!currentAlertData) {
                showPortfolioMessage('Erreur: Donn√©es non charg√©es', 'error');
                return;
            }

            const btn = document.getElementById('addToPortfolioBtn');
            btn.disabled = true;
            btn.textContent = 'Ajout en cours...';

            try {
                const fullData = currentAlertData.full_data || {};

                const portfolioData = {
                    alert_id: parseInt(alertId),
                    pool_address: currentAlertData.pool_address,
                    network: currentAlertData.network,
                    token_symbol: currentAlertData.token_symbol,
                    token_name: currentAlertData.token_name,
                    entry_price: fullData.entry_price || currentAlertData.price,
                    tp1_price: fullData.tp1_price,
                    tp2_price: fullData.tp2_price,
                    tp3_price: fullData.tp3_price,
                    stop_loss_price: fullData.stop_loss_price,
                    notes: `Score: ${currentAlertData.score} | Tier: ${currentAlertData.tier}`
                };

                const response = await fetch(`${API_URL}/portfolio`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(portfolioData)
                });

                const result = await response.json();

                if (response.ok) {
                    showPortfolioMessage('Position ajout√©e au portfolio!', 'success');
                    btn.textContent = '‚úì Ajout√© au Portfolio';
                    btn.classList.remove('bg-purple-500/20', 'text-purple-400', 'border-purple-500/30');
                    btn.classList.add('bg-green-500/20', 'text-green-400', 'border-green-500/30');
                } else {
                    showPortfolioMessage(`Erreur: ${result.error}`, 'error');
                    btn.disabled = false;
                    btn.textContent = '+ Ajouter au Portfolio';
                }

            } catch (error) {
                console.error('Error adding to portfolio:', error);
                showPortfolioMessage('Erreur r√©seau', 'error');
                btn.disabled = false;
                btn.textContent = '+ Ajouter au Portfolio';
            }
        }

        // Show portfolio message
        function showPortfolioMessage(message, type) {
            const msgEl = document.getElementById('portfolioMessage');
            msgEl.className = `mt-4 p-3 rounded ${type === 'success' ? 'bg-green-500/20 text-green-400 border border-green-500/30' : 'bg-red-500/20 text-red-400 border border-red-500/30'}`;
            msgEl.textContent = message;
            msgEl.classList.remove('hidden');

            setTimeout(() => {
                msgEl.classList.add('hidden');
            }, 5000);
        }

        // ============================================================================
        // NETWORK STRATEGIES - R√®gles par r√©seau
        // ============================================================================

        const NETWORK_STRATEGIES = {
            'eth': {
                min_score: 90,
                min_velocity: 5,
                min_liq: 30000,
                max_liq: 5000000,
                min_volume: 30000,
                min_age: 1,
                max_age: 48,
                min_buy_ratio: 0.55,
                bonus_score: 98,
                rules: [
                    { name: 'Score', target: '‚â• 90', check: (a) => a.score >= 90 },
                    { name: 'Liquidit√©', target: '$30K-$5M', check: (a) => a.liquidity >= 30000 && a.liquidity <= 5000000 },
                    { name: 'Volume 24h', target: '‚â• $30K', check: (a) => a.volume_24h >= 30000 },
                    { name: 'V√©locit√©', target: '‚â• 5x', check: (a) => (a.velocite_pump || 0) >= 5 },
                    { name: 'Age', target: '1-48h', check: (a) => a.age_hours >= 1 && a.age_hours <= 48 },
                    { name: 'BONUS', target: 'Score 98-100', check: (a) => a.score >= 98, bonus: true }
                ]
            },
            'solana': {
                min_score: 95,
                min_velocity: 5,
                min_liq: 30000,
                max_liq: 2000000,
                min_volume: 30000,
                min_age: 1,
                max_age: 48,
                min_buy_ratio: 0.55,
                bonus_score: 98,
                rules: [
                    { name: 'Score', target: '‚â• 95 (STRICT!)', check: (a) => a.score >= 95 },
                    { name: 'Liquidit√©', target: '$30K-$2M', check: (a) => a.liquidity >= 30000 && a.liquidity <= 2000000 },
                    { name: 'Volume 24h', target: '‚â• $30K', check: (a) => a.volume_24h >= 30000 },
                    { name: 'V√©locit√©', target: '‚â• 5x', check: (a) => (a.velocite_pump || 0) >= 5 },
                    { name: 'Buy Ratio', target: '‚â• 55%', check: (a) => (a.buy_ratio || 0) >= 0.55 },
                    { name: 'Age', target: '1-48h', check: (a) => a.age_hours >= 1 && a.age_hours <= 48 },
                    { name: 'BONUS', target: 'Score 98-100', check: (a) => a.score >= 98, bonus: true }
                ]
            },
            'bsc': {
                min_score: 95,
                min_velocity: 5,
                min_liq: 30000,
                max_liq: 50000000,
                min_volume: 50000,
                min_age: 1,
                max_age: 48,
                min_buy_ratio: 0.6,
                bonus_score: 98,
                rules: [
                    { name: 'Score', target: '‚â• 95', check: (a) => a.score >= 95 },
                    { name: 'Tier', target: 'ULTRA_HIGH/HIGH', check: (a) => ['ULTRA_HIGH', 'HIGH'].includes(a.tier) },
                    { name: 'Liquidit√©', target: '$30K-$50M', check: (a) => a.liquidity >= 30000 && a.liquidity <= 50000000 },
                    { name: 'Volume 24h', target: '‚â• $50K', check: (a) => a.volume_24h >= 50000 },
                    { name: 'V√©locit√©', target: '‚â• 5x', check: (a) => (a.velocite_pump || 0) >= 5 },
                    { name: 'Buy Ratio', target: '‚â• 60%', check: (a) => (a.buy_ratio || 0) >= 0.6 },
                    { name: 'Age', target: '1-48h', check: (a) => a.age_hours >= 1 && a.age_hours <= 48 },
                    { name: 'BONUS', target: 'Score 98-100', check: (a) => a.score >= 98, bonus: true }
                ]
            },
            'base': {
                min_score: 90,
                min_velocity: 7,
                min_liq: 30000,
                max_liq: 5000000,
                min_volume: 30000,
                min_age: 1,
                max_age: 48,
                bonus_score: 98,
                rules: [
                    { name: 'Score', target: '‚â• 90', check: (a) => a.score >= 90 },
                    { name: 'Liquidit√©', target: '$30K-$5M', check: (a) => a.liquidity >= 30000 && a.liquidity <= 5000000 },
                    { name: 'Volume 24h', target: '‚â• $30K', check: (a) => a.volume_24h >= 30000 },
                    { name: 'V√©locit√©', target: '‚â• 7x (STRICT)', check: (a) => (a.velocite_pump || 0) >= 7 },
                    { name: 'Age', target: '1-48h', check: (a) => a.age_hours >= 1 && a.age_hours <= 48 },
                    { name: 'BONUS', target: 'Score 98-100', check: (a) => a.score >= 98, bonus: true }
                ]
            },
            'arbitrum': {
                min_score: 98,
                min_velocity: 5,
                min_liq: 30000,
                max_liq: 5000000,
                min_volume: 30000,
                min_age: 1,
                max_age: 48,
                bonus_score: 98,
                rules: [
                    { name: 'Score', target: '‚â• 98 (TR√àS STRICT!)', check: (a) => a.score >= 98 },
                    { name: 'Liquidit√©', target: '$30K-$5M', check: (a) => a.liquidity >= 30000 && a.liquidity <= 5000000 },
                    { name: 'Volume 24h', target: '‚â• $30K', check: (a) => a.volume_24h >= 30000 },
                    { name: 'V√©locit√©', target: '‚â• 5x', check: (a) => (a.velocite_pump || 0) >= 5 },
                    { name: 'Age', target: '1-48h', check: (a) => a.age_hours >= 1 && a.age_hours <= 48 },
                    { name: 'BONUS', target: 'Score 98-100', check: (a) => a.score >= 98, bonus: true }
                ]
            },
            'polygon_pos': {
                min_score: 90,
                min_velocity: 5,
                min_liq: 30000,
                max_liq: 5000000,
                min_volume: 30000,
                bonus_score: 98,
                rules: [
                    { name: 'Score', target: '‚â• 90', check: (a) => a.score >= 90 },
                    { name: 'Liquidit√©', target: '$30K-$5M', check: (a) => a.liquidity >= 30000 && a.liquidity <= 5000000 },
                    { name: 'Volume 24h', target: '‚â• $30K', check: (a) => a.volume_24h >= 30000 },
                    { name: 'V√©locit√©', target: '‚â• 5x', check: (a) => (a.velocite_pump || 0) >= 5 },
                    { name: 'BONUS', target: 'Score 98-100', check: (a) => a.score >= 98, bonus: true }
                ]
            },
            'avax': {
                min_score: 90,
                min_velocity: 5,
                min_liq: 30000,
                max_liq: 5000000,
                min_volume: 30000,
                bonus_score: 98,
                rules: [
                    { name: 'Score', target: '‚â• 90', check: (a) => a.score >= 90 },
                    { name: 'Liquidit√©', target: '$30K-$5M', check: (a) => a.liquidity >= 30000 && a.liquidity <= 5000000 },
                    { name: 'Volume 24h', target: '‚â• $30K', check: (a) => a.volume_24h >= 30000 },
                    { name: 'V√©locit√©', target: '‚â• 5x', check: (a) => (a.velocite_pump || 0) >= 5 },
                    { name: 'BONUS', target: 'Score 98-100', check: (a) => a.score >= 98, bonus: true }
                ]
            }
        };

        // ============================================================================
        // STRATEGY INTEGRATION
        // ============================================================================

        function populateStrategyAnalysis(alert, previousAlerts = []) {
            // Calculate auto score
            const { score, breakdown } = calculateAutoScore(alert);

            // Check optimal zone and checklist FIRST
            const zoneCheck = checkOptimalZone(alert);
            const checklist = generateChecklist(alert, zoneCheck);

            // Get recommendation based on BOTH score AND checklist
            const checklistRatio = checklist.passed / checklist.total;
            const recommendation = getFinalRecommendation(score, checklistRatio, checklist.passed, checklist.total);

            // Update Score & Recommendation
            const scoreEl = document.getElementById('autoScore');
            scoreEl.textContent = `${score}/100`;
            scoreEl.className = 'score-badge ' + (score >= 85 ? 'excellent' : score >= 70 ? 'good' : score >= 55 ? 'medium' : 'low');

            document.getElementById('recommendation').textContent = recommendation.action;
            document.getElementById('positionRec').textContent = recommendation.position;
            document.getElementById('confidence').textContent = recommendation.confidence;

            // Style signal card based on score
            const signalCard = document.getElementById('signalCard');
            if (score >= 85) {
                signalCard.classList.add('strong-buy');
            } else if (score < 55) {
                signalCard.classList.add('warning');
            }

            // Populate breakdown (collapsible)
            const breakdownList = document.getElementById('breakdownList');
            breakdownList.innerHTML = breakdown.map(item => `
                <div class="breakdown-item ${item.highlight ? 'highlight' : ''}">
                    <span>${item.label}</span>
                    <span class="ml-auto font-bold text-purple-400">+${item.points}</span>
                </div>
            `).join('');

            // Optimal Zone Detection (already calculated above)
            const optimalZoneEl = document.getElementById('optimalZone');

            if (zoneCheck && zoneCheck.isOptimal) {
                optimalZoneEl.innerHTML = `
                    <div class="p-3 rounded-lg bg-green-500/10 border border-green-500/30">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-xl">üéØ</span>
                            <span class="font-bold text-green-400">${zoneCheck.name}</span>
                        </div>
                        <div class="text-xs text-gray-400 space-y-1">
                            <div>‚Ä¢ Performance: ${zoneCheck.performance}</div>
                            <div>‚Ä¢ Win rate: ${zoneCheck.winRate}</div>
                            <div>‚Ä¢ Gain moyen: ${zoneCheck.avgGain}</div>
                        </div>
                    </div>
                `;
                document.getElementById('patternsCard').classList.add('optimal');
            } else if (zoneCheck) {
                optimalZoneEl.innerHTML = `
                    <div class="text-sm text-gray-400">
                        <div class="mb-2">${zoneCheck.name} (${zoneCheck.passedCount}/${zoneCheck.totalCount} crit√®res)</div>
                        <div class="text-xs">Manque: ${zoneCheck.criteriaResults.filter(c => !c.passed).map(c => c.criterion).join(', ')}</div>
                    </div>
                `;
            }

            // Pattern Detection
            const patternsList = document.getElementById('patternsList');
            const patterns = [];

            // Retracement pattern
            if (previousAlerts.length >= 3) {
                const retracement = detectRetracement(previousAlerts);
                if (retracement && retracement.detected) {
                    patterns.push(`
                        <div class="pattern-badge detected">
                            ‚ö° Pattern Retracement (${retracement.retracePct}% ‚Üí +${retracement.expectedGain}% attendu)
                        </div>
                    `);
                }
            }

            // Multiple alerts pattern
            if (previousAlerts.length >= 5) {
                patterns.push(`
                    <div class="pattern-badge detected">
                        üî• Alertes Multiples (√ó${previousAlerts.length})
                    </div>
                `);
            }

            patternsList.innerHTML = patterns.join('');

            // Ultra-bullish signals
            const bullishSignals = detectUltraBullishSignals(alert, previousAlerts.length);
            if (bullishSignals.length >= 3) {
                document.getElementById('bullishSignals').innerHTML = `
                    <div class="p-3 rounded-lg bg-purple-500/10 border border-purple-500/30">
                        <div class="font-bold text-purple-400 mb-2">üöÄ Signaux Ultra-Bullish (${bullishSignals.length}/5)</div>
                        <div class="text-xs text-gray-300 space-y-1">
                            ${bullishSignals.map(s => `<div>‚Ä¢ ${s}</div>`).join('')}
                        </div>
                        ${bullishSignals.length >= 5 ? '<div class="mt-2 text-xs font-bold text-purple-400">‚Üí ALL-IN 10% capital recommand√©</div>' : ''}
                    </div>
                `;
            }

            // Dynamic Targets
            const targets = calculateDynamicTargets(alert, previousAlerts);

            document.getElementById('dynamicEntry').textContent = formatPrice(targets.entry);
            document.getElementById('dynamicSL').textContent = `${formatPrice(targets.stopLoss.price)} (${targets.stopLoss.percent}%)`;
            document.getElementById('dynamicTP1').textContent = `${formatPrice(targets.tp1.price)} (+${targets.tp1.percent.toFixed(1)}%) ‚Üí Exit ${targets.tp1.exitAmount}%`;
            document.getElementById('dynamicTP2').textContent = `${formatPrice(targets.tp2.price)} (+${targets.tp2.percent.toFixed(1)}%) ‚Üí Exit ${targets.tp2.exitAmount}%`;
            document.getElementById('dynamicTP3').textContent = `${formatPrice(targets.tp3.price)} (+${targets.tp3.percent.toFixed(1)}%) ‚Üí Exit ${targets.tp3.exitAmount}%`;
            document.getElementById('dynamicTS').textContent = `${targets.trailStop.percent}% ${targets.trailStop.activation}`;

            // Reasoning
            document.getElementById('targetReasoning').innerHTML = targets.reasoning.map(r => `
                <div class="text-xs">${r}</div>
            `).join('');

            document.getElementById('multiplierValue').textContent = `√ó${targets.multiplier}`;

            const riskEl = document.getElementById('riskLevel');
            riskEl.textContent = targets.riskLevel;
            riskEl.className = `text-sm font-bold ${targets.riskLevel === 'LOW' ? 'text-green-400' : targets.riskLevel === 'HIGH' ? 'text-red-400' : 'text-yellow-400'}`;

            // Update Checklist Title with Network Name
            const network = (alert.network || '').toUpperCase();
            document.getElementById('checklistNetworkTitle').textContent = `Strat√©gie ${network}`;

            // Determine strategy stage based on checklist results
            let stage, stageColor, stageIcon, stageBg;
            if (checklist.passed === checklist.total) {
                if (checklist.hasBonus) {
                    stage = 'PRIORIT√â MAXIMALE - BONUS ACTIV√â!';
                    stageColor = 'text-purple-400';
                    stageIcon = 'üöÄ';
                    stageBg = 'border-purple-500 bg-purple-900/30';
                } else {
                    stage = 'READY TO TRADE';
                    stageColor = 'text-green-400';
                    stageIcon = '‚úì';
                    stageBg = 'border-green-500 bg-green-900/20';
                }
            } else if (checklist.passed >= checklist.total * 0.7) {
                stage = 'CAUTION - V√âRIFIER CONDITIONS';
                stageColor = 'text-yellow-400';
                stageIcon = '‚ö†';
                stageBg = 'border-yellow-500 bg-yellow-900/20';
            } else {
                stage = 'NE PAS TRADER';
                stageColor = 'text-red-400';
                stageIcon = '‚úó';
                stageBg = 'border-red-500 bg-red-900/20';
            }

            // Display Strategy Status Banner
            const statusBanner = document.getElementById('strategyStatusBanner');
            statusBanner.innerHTML = `
                <div class="p-4 rounded-lg border-2 ${stageBg}">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">${stageIcon}</span>
                            <span class="font-bold text-lg ${stageColor}">${stage}</span>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-400">Progression</div>
                            <div class="font-bold text-xl ${stageColor}">${checklist.passed}/${checklist.total}</div>
                        </div>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2">
                        <div class="${stageColor.replace('text-', 'bg-')} h-2 rounded-full transition-all" style="width: ${(checklist.passed / checklist.total * 100).toFixed(0)}%"></div>
                    </div>
                </div>
            `;

            // Checklist (already calculated above)
            const checklistEl = document.getElementById('checklistCriteria');

            checklistEl.innerHTML = checklist.items.map(item => {
                if (item.isBonus) {
                    // Bonus rule styling
                    const bonusBg = item.passed ? 'bg-purple-900/30 border-l-4 border-purple-500' : 'bg-gray-900/30 border-l-4 border-gray-600';
                    const bonusIcon = item.passed ? 'üöÄ' : '‚óã';
                    return `
                        <div class="p-3 rounded-lg ${bonusBg} mb-2">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">${bonusIcon}</span>
                                <div class="flex-1">
                                    <div class="text-sm font-semibold flex items-center gap-2">
                                        ${item.label}
                                        <span class="text-xs bg-purple-500/20 text-purple-400 px-2 py-0.5 rounded">BONUS</span>
                                    </div>
                                    <div class="text-xs ${item.passed ? 'text-purple-400' : 'text-gray-500'} font-bold mt-1">${item.value}</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Regular rule styling
                    return `
                        <div class="checklist-item ${item.passed ? 'passed' : 'failed'}">
                            <span class="text-xl">${item.passed ? '‚úÖ' : '‚ùå'}</span>
                            <div class="flex-1">
                                <div class="text-sm font-semibold">${item.label}</div>
                                <div class="text-xs ${item.passed ? 'text-green-400' : 'text-red-400'} font-bold mt-1">${item.value}</div>
                            </div>
                        </div>
                    `;
                }
            }).join('');

            document.getElementById('checklistScore').textContent = `${checklist.passed}/${checklist.total}`;
            document.getElementById('checklistScore').className = `font-bold text-lg ${checklist.passed === checklist.total ? 'text-green-400' : checklist.passed >= checklist.total * 0.7 ? 'text-yellow-400' : 'text-red-400'}`;

            // Result message
            const resultEl = document.getElementById('checklistResult');
            if (checklist.passed === checklist.total) {
                resultEl.innerHTML = `
                    <div class="p-3 rounded-lg bg-green-500/10 border border-green-500/30 text-green-400 text-sm font-bold">
                        üéØ Tous les crit√®res valid√©s - GO TRADE!
                    </div>
                `;
            } else if (checklist.passed >= checklist.total * 0.7) {
                resultEl.innerHTML = `
                    <div class="p-3 rounded-lg bg-yellow-500/10 border border-yellow-500/30 text-yellow-400 text-sm">
                        ‚ö†Ô∏è Entry possible mais prudent
                    </div>
                `;
            } else {
                resultEl.innerHTML = `
                    <div class="p-3 rounded-lg bg-red-500/10 border border-red-500/30 text-red-400 text-sm">
                        üî¥ Crit√®res insuffisants - SKIP
                    </div>
                `;
            }
        }

        function generateChecklist(alert, zoneCheck) {
            const network = (alert.network || '').toLowerCase();
            const strategy = NETWORK_STRATEGIES[network] || NETWORK_STRATEGIES['eth'];

            // Validate each rule from the network strategy
            const ruleResults = strategy.rules.map(rule => ({
                ...rule,
                passed: rule.check(alert)
            }));

            // Separate critical rules from bonus rules
            const criticalRules = ruleResults.filter(r => !r.bonus);
            const bonusRules = ruleResults.filter(r => r.bonus);

            const items = [];

            // Add critical rules to checklist
            for (const rule of criticalRules) {
                let currentValue = '';

                // Get current value for each metric
                if (rule.name === 'Score') {
                    currentValue = `${alert.score}/100`;
                } else if (rule.name === 'V√©locit√©') {
                    currentValue = `${(alert.velocite_pump || 0).toFixed(1)}x`;
                } else if (rule.name === 'Liquidit√©') {
                    currentValue = `$${formatNumber(alert.liquidity || 0)}`;
                } else if (rule.name === 'Volume 24h') {
                    currentValue = `$${formatNumber(alert.volume_24h || 0)}`;
                } else if (rule.name === 'Age') {
                    const ageH = alert.age_hours || 0;
                    currentValue = ageH < 1 ? `${Math.floor(ageH * 60)}min` : `${ageH.toFixed(1)}h`;
                } else if (rule.name === 'Buy Ratio') {
                    currentValue = `${((alert.buy_ratio || 0) * 100).toFixed(1)}%`;
                } else if (rule.name === 'Tier') {
                    currentValue = alert.tier || 'N/A';
                } else {
                    currentValue = 'N/A';
                }

                items.push({
                    label: `${rule.name}: ${rule.target}`,
                    value: `Actuel: ${currentValue} ${rule.passed ? '‚úì ATTEINTE' : '‚úó NON ATTEINTE'}`,
                    passed: rule.passed,
                    isBonus: false
                });
            }

            // Add bonus rules
            for (const rule of bonusRules) {
                items.push({
                    label: `${rule.name}: ${rule.target}`,
                    value: rule.passed ? 'üöÄ BONUS ACTIV√â!' : 'Bonus non atteint',
                    passed: rule.passed,
                    isBonus: true
                });
            }

            const passed = criticalRules.filter(r => r.passed).length;
            const total = criticalRules.length;
            const hasBonus = bonusRules.length > 0 && bonusRules[0].passed;

            return { items, passed, total, hasBonus };
        }

        function getFinalRecommendation(score, checklistRatio, checklistPassed, checklistTotal) {
            // La checklist a la priorit√© finale
            // Si checklist < 60% (moins de 3/5) ‚Üí SKIP peu importe le score
            // Si checklist 60-80% (3-4/5) ‚Üí PRUDENT (sauf si score tr√®s √©lev√©)
            // Si checklist 100% (5/5) ‚Üí Suivre le score

            if (checklistRatio < 0.6) {
                // Moins de 60% des crit√®res ‚Üí SKIP
                return {
                    action: 'üî¥ SKIP',
                    position: '0% capital',
                    confidence: 'Crit√®res insuffisants'
                };
            } else if (checklistRatio < 1.0) {
                // 60-99% des crit√®res ‚Üí PRUDENT ou BUY selon score
                if (score >= 85) {
                    return {
                        action: 'üü° BUY (Prudent)',
                        position: '3-5% capital',
                        confidence: `${Math.round(checklistRatio * 100)}% crit√®res (${checklistPassed}/${checklistTotal})`
                    };
                } else if (score >= 70) {
                    return {
                        action: '‚ö†Ô∏è PRUDENT',
                        position: '3% capital max',
                        confidence: `${Math.round(checklistRatio * 100)}% crit√®res (${checklistPassed}/${checklistTotal})`
                    };
                } else {
                    return {
                        action: 'üî¥ SKIP',
                        position: '0% capital',
                        confidence: 'Score + crit√®res insuffisants'
                    };
                }
            } else {
                // 100% des crit√®res ‚Üí Suivre le score
                if (score >= 95) {
                    return {
                        action: 'üü¢ STRONG BUY',
                        position: '10% capital',
                        confidence: '95%+'
                    };
                } else if (score >= 85) {
                    return {
                        action: 'üü¢ BUY',
                        position: '7% capital',
                        confidence: '85%+'
                    };
                } else if (score >= 70) {
                    return {
                        action: 'üü° BUY (Mod√©r√©)',
                        position: '5% capital',
                        confidence: '70%+'
                    };
                } else if (score >= 55) {
                    return {
                        action: '‚ö†Ô∏è HOLD',
                        position: '3% capital',
                        confidence: '55%+'
                    };
                } else {
                    return {
                        action: 'üî¥ SKIP',
                        position: '0% capital',
                        confidence: 'Score trop faible'
                    };
                }
            }
        }

        function toggleBreakdown() {
            const list = document.getElementById('breakdownList');
            const icon = document.getElementById('breakdownIcon');

            if (list.style.display === 'none') {
                list.style.display = 'block';
                icon.textContent = '‚ñº';
            } else {
                list.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', loadToken);
    </script>
</body>
</html>
