#!/usr/bin/env python3
"""
Analyse detaillee des champs numeriques non exploites.
Objectif: Trouver les correlations avec le winrate pour les nouveaux filtres.
"""

import json
from pathlib import Path
from collections import defaultdict

EXPORT_FILE = Path(__file__).parent.parent / "alerts_railway_export.json"


def load_alerts():
    encodings = ['utf-16-le', 'utf-16', 'utf-8', 'utf-8-sig']
    for encoding in encodings:
        try:
            with open(EXPORT_FILE, 'r', encoding=encoding) as f:
                content = f.read()
            if '\x00' in content:
                content = content.replace('\x00', '')
            json_start = content.find('{')
            if json_start > 0:
                content = content[json_start:]
            data = json.loads(content)
            return data.get('alerts', [])
        except:
            continue
    raise ValueError("Cannot load file")


def prepare_alerts(alerts, network):
    """Prepare alerts with win/loss for a specific network."""
    valid = []
    for alert in alerts:
        if alert.get('network') != network:
            continue

        price_at = alert.get('price_at_alert') or alert.get('entry_price')
        price_after = alert.get('price_1h_after')

        if not price_at or not price_after:
            continue

        try:
            pct = (float(price_after) - float(price_at)) / float(price_at) * 100
            alert['_pct'] = pct
            alert['_win'] = pct >= 5
            alert['_loss'] = pct <= -10
            valid.append(alert)
        except:
            continue

    return valid


def analyze_numeric_field(alerts, field_name, ranges):
    """Analyze a numeric field with given ranges."""
    results = []

    for vmin, vmax, label in ranges:
        subset = [a for a in alerts if a.get(field_name) is not None
                  and vmin <= float(a.get(field_name, 0)) < vmax]

        if len(subset) >= 20:
            wins = sum(1 for a in subset if a['_win'])
            losses = sum(1 for a in subset if a['_loss'])
            decided = wins + losses

            if decided >= 10:
                wr = wins / decided * 100
                results.append((wr, len(subset), decided, wins, losses, label))

    return sorted(results, reverse=True)


def main():
    print("=" * 70)
    print("ANALYSE CHAMPS NUMERIQUES NON EXPLOITES")
    print("=" * 70)

    alerts = load_alerts()
    print(f"Total alertes: {len(alerts):,}")

    for network in ['solana', 'eth']:
        valid = prepare_alerts(alerts, network)
        if len(valid) < 100:
            continue

        print(f"\n{'='*60}")
        print(f"{network.upper()} - {len(valid)} alertes analysables")
        print("=" * 60)

        # 1. momentum_bonus
        print("\n--- MOMENTUM_BONUS ---")
        ranges = [
            (0, 5, "0-5 (faible)"),
            (5, 10, "5-10"),
            (10, 20, "10-20"),
            (20, 30, "20-30"),
            (30, 50, "30-50 (fort)"),
            (50, 200, "50+ (tres fort)"),
        ]
        results = analyze_numeric_field(valid, 'momentum_bonus', ranges)
        for wr, total, decided, wins, losses, label in results:
            marker = " ***" if wr >= 65 else " **" if wr >= 55 else ""
            print(f"  {label}: {total} alertes | WR: {wr:.1f}% ({wins}W/{losses}L){marker}")

        # 2. confidence_score
        print("\n--- CONFIDENCE_SCORE ---")
        ranges = [
            (0, 50, "<50 (bas)"),
            (50, 70, "50-70"),
            (70, 80, "70-80"),
            (80, 90, "80-90"),
            (90, 101, "90+ (haut)"),
        ]
        results = analyze_numeric_field(valid, 'confidence_score', ranges)
        for wr, total, decided, wins, losses, label in results:
            marker = " ***" if wr >= 65 else " **" if wr >= 55 else ""
            print(f"  {label}: {total} alertes | WR: {wr:.1f}% ({wins}W/{losses}L){marker}")

        # 3. base_score
        print("\n--- BASE_SCORE ---")
        ranges = [
            (0, 60, "<60"),
            (60, 70, "60-70"),
            (70, 80, "70-80"),
            (80, 90, "80-90"),
            (90, 101, "90+"),
        ]
        results = analyze_numeric_field(valid, 'base_score', ranges)
        for wr, total, decided, wins, losses, label in results:
            marker = " ***" if wr >= 65 else " **" if wr >= 55 else ""
            print(f"  {label}: {total} alertes | WR: {wr:.1f}% ({wins}W/{losses}L){marker}")

        # 4. volume_acceleration_1h_vs_6h
        print("\n--- VOLUME_ACCELERATION_1H_VS_6H ---")
        ranges = [
            (0, 0.2, "<0.2 (ralentissement)"),
            (0.2, 0.5, "0.2-0.5"),
            (0.5, 1.0, "0.5-1.0 (stable)"),
            (1.0, 2.0, "1.0-2.0 (acceleration)"),
            (2.0, 5.0, "2.0-5.0 (forte acceleration)"),
            (5.0, 100, "5.0+ (extreme)"),
        ]
        results = analyze_numeric_field(valid, 'volume_acceleration_1h_vs_6h', ranges)
        for wr, total, decided, wins, losses, label in results:
            marker = " ***" if wr >= 65 else " **" if wr >= 55 else ""
            print(f"  {label}: {total} alertes | WR: {wr:.1f}% ({wins}W/{losses}L){marker}")

        # 5. volume_acceleration_6h_vs_24h
        print("\n--- VOLUME_ACCELERATION_6H_VS_24H ---")
        ranges = [
            (0, 0.2, "<0.2 (ralentissement)"),
            (0.2, 0.5, "0.2-0.5"),
            (0.5, 1.0, "0.5-1.0"),
            (1.0, 2.0, "1.0-2.0"),
            (2.0, 4.0, "2.0-4.0"),
            (4.0, 100, "4.0+ (extreme)"),
        ]
        results = analyze_numeric_field(valid, 'volume_acceleration_6h_vs_24h', ranges)
        for wr, total, decided, wins, losses, label in results:
            marker = " ***" if wr >= 65 else " **" if wr >= 55 else ""
            print(f"  {label}: {total} alertes | WR: {wr:.1f}% ({wins}W/{losses}L){marker}")

        # 6. temps_depuis_alerte_precedente
        print("\n--- TEMPS_DEPUIS_ALERTE_PRECEDENTE (heures) ---")
        ranges = [
            (0, 0.1, "<6min (rafale)"),
            (0.1, 0.5, "6-30min"),
            (0.5, 1.0, "30min-1h"),
            (1.0, 2.0, "1-2h"),
            (2.0, 6.0, "2-6h"),
            (6.0, 24.0, "6-24h"),
            (24.0, 1000, ">24h (premiere)"),
        ]
        results = analyze_numeric_field(valid, 'temps_depuis_alerte_precedente', ranges)
        for wr, total, decided, wins, losses, label in results:
            marker = " ***" if wr >= 65 else " **" if wr >= 55 else ""
            print(f"  {label}: {total} alertes | WR: {wr:.1f}% ({wins}W/{losses}L){marker}")

        # 7. volume_1h
        print("\n--- VOLUME_1H ---")
        if network == 'solana':
            ranges = [
                (0, 50_000, "<50K"),
                (50_000, 100_000, "50-100K"),
                (100_000, 200_000, "100-200K"),
                (200_000, 500_000, "200-500K"),
                (500_000, 1_000_000, "500K-1M"),
                (1_000_000, 10_000_000, ">1M"),
            ]
        else:
            ranges = [
                (0, 10_000, "<10K"),
                (10_000, 25_000, "10-25K"),
                (25_000, 50_000, "25-50K"),
                (50_000, 100_000, "50-100K"),
                (100_000, 1_000_000, ">100K"),
            ]
        results = analyze_numeric_field(valid, 'volume_1h', ranges)
        for wr, total, decided, wins, losses, label in results:
            marker = " ***" if wr >= 65 else " **" if wr >= 55 else ""
            print(f"  {label}: {total} alertes | WR: {wr:.1f}% ({wins}W/{losses}L){marker}")

        # 8. total_txns
        print("\n--- TOTAL_TXNS ---")
        if network == 'solana':
            ranges = [
                (0, 1000, "<1K"),
                (1000, 5000, "1-5K"),
                (5000, 10000, "5-10K"),
                (10000, 25000, "10-25K"),
                (25000, 50000, "25-50K"),
                (50000, 1000000, ">50K"),
            ]
        else:
            ranges = [
                (0, 500, "<500"),
                (500, 1000, "500-1K"),
                (1000, 2500, "1-2.5K"),
                (2500, 5000, "2.5-5K"),
                (5000, 100000, ">5K"),
            ]
        results = analyze_numeric_field(valid, 'total_txns', ranges)
        for wr, total, decided, wins, losses, label in results:
            marker = " ***" if wr >= 65 else " **" if wr >= 55 else ""
            print(f"  {label}: {total} alertes | WR: {wr:.1f}% ({wins}W/{losses}L){marker}")

        # 9. score (global)
        print("\n--- SCORE (global) ---")
        ranges = [
            (0, 60, "<60"),
            (60, 70, "60-70"),
            (70, 80, "70-80"),
            (80, 90, "80-90"),
            (90, 95, "90-95"),
            (95, 101, "95+"),
        ]
        results = analyze_numeric_field(valid, 'score', ranges)
        for wr, total, decided, wins, losses, label in results:
            marker = " ***" if wr >= 65 else " **" if wr >= 55 else ""
            print(f"  {label}: {total} alertes | WR: {wr:.1f}% ({wins}W/{losses}L){marker}")

        # 10. is_alerte_suivante
        print("\n--- IS_ALERTE_SUIVANTE ---")
        for val in [0, 1]:
            subset = [a for a in valid if a.get('is_alerte_suivante') == val]
            if len(subset) >= 20:
                wins = sum(1 for a in subset if a['_win'])
                losses = sum(1 for a in subset if a['_loss'])
                decided = wins + losses
                if decided >= 10:
                    wr = wins / decided * 100
                    label = "Premiere alerte" if val == 0 else "Alerte suivante"
                    marker = " ***" if wr >= 65 else " **" if wr >= 55 else ""
                    print(f"  {label}: {len(subset)} alertes | WR: {wr:.1f}% ({wins}W/{losses}L){marker}")

        # 11. decision_tp_tracking
        print("\n--- DECISION_TP_TRACKING ---")
        by_decision = defaultdict(lambda: {'wins': 0, 'losses': 0, 'total': 0})
        for alert in valid:
            dec = alert.get('decision_tp_tracking', 'UNKNOWN')
            by_decision[dec]['total'] += 1
            if alert['_win']:
                by_decision[dec]['wins'] += 1
            elif alert['_loss']:
                by_decision[dec]['losses'] += 1

        for dec, stats in sorted(by_decision.items(), key=lambda x: -x[1]['total']):
            decided = stats['wins'] + stats['losses']
            if decided >= 10:
                wr = stats['wins'] / decided * 100
                marker = " ***" if wr >= 65 else " **" if wr >= 55 else ""
                print(f"  {dec}: {stats['total']} alertes | WR: {wr:.1f}% ({stats['wins']}W/{stats['losses']}L){marker}")

        # 12. tier actuel
        print("\n--- TIER (actuel) ---")
        by_tier = defaultdict(lambda: {'wins': 0, 'losses': 0, 'total': 0})
        for alert in valid:
            tier = alert.get('tier', 'UNKNOWN')
            by_tier[tier]['total'] += 1
            if alert['_win']:
                by_tier[tier]['wins'] += 1
            elif alert['_loss']:
                by_tier[tier]['losses'] += 1

        for tier, stats in sorted(by_tier.items(), key=lambda x: -x[1]['total']):
            decided = stats['wins'] + stats['losses']
            if decided >= 10:
                wr = stats['wins'] / decided * 100
                marker = " ***" if wr >= 65 else " **" if wr >= 55 else ""
                print(f"  {tier}: {stats['total']} alertes | WR: {wr:.1f}% ({stats['wins']}W/{stats['losses']}L){marker}")


if __name__ == "__main__":
    main()
